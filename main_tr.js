/*
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
                ğ—›ğ—”ğ—«ğ—•ğ—”ğ—Ÿğ—Ÿ ğ——ğ—œğ—¦ğ—–ğ—¢ğ—¥ğ—— ğ—˜ğ—¡ğ—§ğ—˜ğ—šğ—¥ğ—˜ğ—Ÿğ—œ ğ—šğ—˜ğ—Ÿğ—œğ—¦ğ— ğ—œğ—¦ ğ—•ğ—¢ğ—§
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

ğŸ‰ ğ—šğ—²ğ—¹ğ—¶ğ˜€ğ˜ğ—¶ğ—¿ğ—¶ğ—°ğ—¶ 
 - Discord: kgn.official
 - Version: 1.17

ğŸ‰ Bu proje, kodlama bilgisi olmayan ancak birÃ§ok farklÄ± seÃ§enekle HaxBall odasÄ± oluÅŸturmak ve yÃ¶netmek isteyen kiÅŸilere yardÄ±mcÄ± olmak amacÄ±yla hazÄ±rlanmÄ±ÅŸtÄ±r. 
AyrÄ±ca, Discord entegrasyonu sayesinde kullanÄ±cÄ±lar, oda yÃ¶netimine Discord Ã¼zerinden mÃ¼dahale edebilir, Ã§eÅŸitli komutlarla odayÄ± kontrol edebilir. 

ğŸš€ ğ—¢ğ—¡ğ—˜ ğ—–ğ—œğ—ğ—”ğ—¡ ğ—¢ğ—­ğ—˜ğ—Ÿğ—Ÿğ—œğ—ğ—Ÿğ—˜ğ—¥

 -  GeliÅŸmiÅŸ Ä°statistik Sistemi
 -  Discord Entegrasyonu (Discord Ã¼zerinden oda yÃ¶netimi)
 -  TakÄ±m Ä°Ã§i ve Oyuncu Ä°Ã§i Sohbet
 -  Åut HÄ±zÄ± ile Beraber Gol Bildirimi
 -  Otomatik Oyun KaydÄ±
 -  Admin ve Ban Sistemi
 -  Discord Ãœzerinden Admin Ã‡aÄŸrÄ± Sistemi
 -  Rank Sistemi
  - Ve daha fazlasÄ±!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“œ ğ—¦ğ—¢ğ—¥ğ—¨ğ— ğ—Ÿğ—¨ğ—Ÿğ—¨ğ— ğ—¥ğ—˜ğ——ğ——ğ—œ (ğ——ğ—œğ—¦ğ—–ğ—Ÿğ—”ğ—œğ— ğ—˜ğ—¥)

---

TURKÄ°SH

Bu yazÄ±lÄ±m, "olduÄŸu gibi" sunulmaktadÄ±r ve herhangi bir garanti iÃ§ermez. 
GeliÅŸtiriciler, bu yazÄ±lÄ±mÄ±n kullanÄ±mÄ±ndan doÄŸabilecek doÄŸrudan veya dolaylÄ± 
zararlardan, veri kaybÄ±ndan, hizmet kesintilerinden veya Ã¼Ã§Ã¼ncÃ¼ taraflarÄ±n 
eylemlerinden hiÃ§bir ÅŸekilde sorumlu tutulamaz. 

KullanÄ±cÄ±, bu yazÄ±lÄ±mÄ± kullanarak tÃ¼m sorumluluÄŸu kabul eder ve geliÅŸtiricileri 
her tÃ¼rlÃ¼ yasal ve mali yÃ¼kÃ¼mlÃ¼lÃ¼kten muaf tutar.

Bu proje aÃ§Ä±k kaynaklÄ± olup, kullanÄ±mÄ± tamamen bireysel sorumluluk altÄ±ndadÄ±r. 
Hukuki veya etik sorunlar ile ilgili tÃ¼m sorumluluk kullanÄ±cÄ±ya aittir.

---

ENGLÄ°SH

This software is provided "as is" and does not come with any warranty.
The developers cannot be held responsible for any direct or indirect damages, data loss, service interruptions, or third-party actions resulting from the use of this software.

By using this software, the user accepts all responsibility and releases the developers from any legal or financial liabilities.

This project is open-source, and its use is completely at the user's own risk.
All legal or ethical issues are the responsibility of the user.


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
*/



const DÄ°SCORD_BOT_TOKEN = "" /* Discord bot tokeni oluÅŸturun 
UYARI:
- Botunuza Discordda verdiÄŸiniz rol, rol listesinde en yukarda olmalÄ±dÄ±r. TÃ¼m yetkiler verilmelidir.
- Privileged Gateway Intents ayarlarÄ±nÄ±n hepsi aÃ§Ä±lmalÄ±dÄ±r.
- Bot davet edilirken - OAuth2 kullanarak - scopes ayarlarÄ±ndan application.commands ve bot seÃ§ilmelidir ve Admin yetkisi verilmelidir.

*/

/*  NOT: Ã¶ncelikle genel oda ayarlarÄ±nÄ± kendinize gÃ¶re ayarlayÄ±n boÅŸ bÄ±rakmamanÄ±z tavsiye edilir.
    Kodunuzun adÄ±nÄ± main.js olarak adlandÄ±rÄ±n ve aynÄ± yere bir maps klasÃ¶rÃ¼ oluÅŸturun
    Bu klasÃ¶re;
    training.hbs => antrenman mapi
    classic.hbs => 1v1 ve 2v2 mapi ORTAKTIR!
    big.hbs => 3v3 mapi 
    ekleyin.

*/
/*â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ GENEL AYARLAR â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ*/
/* Bu kÄ±sÄ±mda kullanacaÄŸÄ±m kÃ¼tÃ¼phaneler yer alÄ±yor.
 - haxball.js => node.js Ã¼zerinden oda baÅŸlatmamÄ±za imkan tanÄ±yan npm modÃ¼lÃ¼
 - node-localstorage => TarayÄ±cÄ±daki localStorage i daha geliÅŸmiÅŸ olarak yerel bir depolama alanÄ± olarak kullanmamÄ±zÄ± saÄŸlÄ±yor.
 - fs ve path maps klasÃ¶rÃ¼nden mapleri Ã§ekerken kullandÄ±m sadece Ã§ok Ã¶nemli deÄŸil kodun temiz kalmasÄ± iÃ§in ekledim
*/
const HaxballJS = require('haxball.js');
const { LocalStorage } = require('node-localstorage');
const { Client, GatewayIntentBits, SlashCommandBuilder,EmbedBuilder } = require('discord.js');
const fs = require('fs');
const path = require('path');
const LocalStatsStorage = new LocalStorage('./Stats'); // Oyuncu Ä°statistikleri oyuncu adÄ± anahtar olarak kullanarak depolanÄ±yor.
const LocalProfilesStorage = new LocalStorage('./Profiles'); // Haxball hesaplarÄ±nÄ±n ÅŸifreleri, authlar, connlar... depolanÄ±yor
const LocalListsStorage = new LocalStorage('./Lists'); // admin listesi, ban listesi ... depolanÄ±yor
const LocalDiscordProfilesStorage = new LocalStorage('./DiscordProfiles'); // discord haxball hesap eÅŸleÅŸtirmeleri depolanÄ±yor

/*â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ GENEL ODA AYARLARI â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ*/
console.clear()
var callWebhook = ''; // Admin Ã§aÄŸrÄ±larÄ±nÄ±n gideceÄŸi webhook, Ã¶zel bir kanal yapmalÄ±sÄ±nÄ±z.
const roleMentions = "<@&1029434387794774485> <@&1029443499776012457>"; // Buraya Ã§aÄŸrÄ± sÄ±rasÄ±nda etiketlenecek admin rollerinin ID lerini ekleyin
// Verilen rol ID leri Ã¶rnektir eÄŸer o kanala eriÅŸimi olan herkesin gÃ¶rmesini istiyorsanÄ±z @everyone da ekleyebilirsiniz.
var gameWebhook = '';  // MaÃ§ kayÄ±tlarÄ±nÄ±n gideceÄŸi webhook, herkese aÃ§Ä±k bir kanal olmalÄ±
var banWebhook = ''; // Ban iÅŸlemlerinin gideceÄŸi webhook.

// PEKÄ° WEBHOOK NASIL OLUÅTURURUM? => https://support.discord.com/hc/en-us/articles/228383668-Intro-to-Webhooks

const ADMIN_ROLE_ID = '1329444499726012457';  // Discord admin komutlarÄ±na eriÅŸimi olan rolÃ¼n ID si

// OdanÄ±n Konum Bilgileri
// TÃ¼m odalarÄ±n konumunu gÃ¶rebileceÄŸiniz API => https://api.sefinek.net/api/v2/haxball/room-list
const LAT = 40.200005
const LON = 29

var drawTimeLimit = 10; // 10 dakika sonunda eÄŸer skorlar eÅŸitse beraberlik ilan edilir.
var defaultSlowMode = 3; // yavaÅŸ mod herkes iÃ§in geÃ§erli

var minAFKDuration = 0; // min afk kalma sÃ¼resi
var maxAFKDuration = 10; // max afk kalma sÃ¼resi sonra kick
var AFKCooldown = 0; // afk komutu kaÃ§ saniyede bir kullanÄ±labilir

const maxPlayers = 10; // Max oyuncu sayÄ±sÄ±
var discordLink = "" // Discord linkiniz
const roomName = ''; // Oda adÄ±
var roomWebhook = ''; // Oda kayÄ±tlarÄ±nÄ±n (odaya katÄ±lma ayrÄ±lma chat...) iletildiÄŸi log webhooku, Ã¶zel kanal olmalÄ±
var roomLink = null
const token = "" // => https://www.haxball.com/headlesstoken 

var masterPassword = 17845 // YÃ¶netici kodudur. Odaya girince !yÃ¶neticikodum kod yazarak kalÄ±cÄ± yetki alÄ±rsÄ±nÄ±z. SÄ±nÄ±rsÄ±z yekti!

var debugMode = false; // OdadanÄ±z test modundaysa true yapÄ±n bu AFK kick vb. ÅŸeyleri kapatacaktÄ±r. AyrÄ±ca public: false olarak ayarlayacaktÄ±r.

var teamSize = 3 // Maksimum takÄ±m kapasitesi (Ã–nerim 3 olarak kalmasÄ±dÄ±r fakat isterseniz 4 yapabilirsiniz)
// Burada unutmamanÄ±z gereken ÅŸey antrenmanda training map 1v1 ve 2v2 de classic 3v3 de ise big map aÃ§Ä±lÄ±r eÄŸer teamsize Ä± 
// 3 den bÃ¼yÃ¼k yaparsanÄ±z yine de bigmap olarak kalacaktÄ±r yani 3 kiÅŸilik map ile 4 kiÅŸilik map aynÄ± map olacaktÄ±r.

const PROXY = null  // Proxy kullanarak birden fazla oda aÃ§abilirsiniz.

/* Proxy aÅŸaÄŸÄ±daki formatta olmalÄ±dÄ±r.

"http://IP:PORT"
                    Ã–rnek: "http://1.1.1.1:80"

*/


// YAPILACAK DUYURULARIN LÄ°STESÄ° SIRASIYLA YAPILIR HER ODA AÃ‡ILDIÄINDA

const announcementList = [
    `Admin baÅŸvurularÄ± aÃ§Ä±lmÄ±ÅŸtÄ±r.Discord adresimizden baÅŸvurabilirsiniz. 
${discordLink}`,
    `Turnuvalar, Ã§ekiliÅŸler ve daha fazlasÄ± iÃ§in Discord sunucumuza katÄ±lÄ±n! 
${discordLink}`,

];




var passwordLengths = { min: 4, max: 8 }; // Åifre iÃ§in min max uzunluk
var loginTimeout = 20; // KaÃ§ saniye iÃ§erisinde giriÅŸ yapÄ±lmazsa atÄ±lsÄ±n ? -- kayÄ±tsÄ±zlar atÄ±lmaz sadece stat kaydedilmez

/*â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ DÄ°SCORD BOTU â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ*/
const client = new Client({ 	
    intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent,
    GatewayIntentBits.GuildMembers,
], });


/*â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ HAXBALL BOTU â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ*/

var password = null

HaxballJS.then((HBInit) => {


var fetchRecordingVariable = true;
var timeLimit = 3;
var scoreLimit = 3;

var gameConfig = {
    roomName: roomName,
    maxPlayers: maxPlayers,
    public: !debugMode,
    noPlayer: true,
    password: password,
    geo: {"code": "tr", "lat": LAT, "lon": LON},
    proxy: PROXY,
    token: token
}
const room = HBInit(gameConfig);
client.room = room // discord ile etkileÅŸime geÃ§mek iÃ§in kullanÄ±lacak nesne

const mapsDir = path.join(__dirname, 'maps');
const trainingMap = fs.readFileSync(path.join(mapsDir, 'training.hbs'), 'utf8');
const classicMap = fs.readFileSync(path.join(mapsDir, 'classic.hbs'), 'utf8');
const bigMap = fs.readFileSync(path.join(mapsDir, 'big.hbs'), 'utf8');
var currentStadium = 'antrenmanmap';

room.setScoreLimit(scoreLimit);
room.setTimeLimit(timeLimit);
room.setTeamsLock(true);
room.setKickRateLimit(6, 0, 0);

var roomPassword = '';

/* OPTIONS */

var maxAdmins = 0;
var disableBans = false;
var afkLimit = debugMode ? Infinity : 15

var chooseModeSlowMode = 0;
var slowMode = defaultSlowMode;
var SMSet = new Set();

var mentionPlayersUnpause = true;

var darkBlue = 0x037ff6
var lightBlue = 0x01d6f9

/* ADMÄ°N CALL */

var lastCall = null; // Son Ã§aÄŸrÄ±lma zamanÄ±

function callAdminCommand(player, message) {
    const now = Date.now();   
    
    // EÄŸer son komut Ã§aÄŸrÄ±lma zamanÄ± 3 dakikadan kÄ±sa ise
    if (lastCall && now - lastCall < 3 * 60 * 1000) {
        // Kalan sÃ¼reyi hesapla
        const remainingTime = 3 * 60 * 1000 - (now - lastCall);
        const remainingMinutes = Math.floor(remainingTime / (60 * 1000)); // Dakika
        const remainingSeconds = Math.floor((remainingTime % (60 * 1000)) / 1000); // Saniye
        
        // Kalan sÃ¼reyi oyuncuya bildir
        room.sendAnnouncement(
            `${player.name}, bu komutu tekrar kullanabilmek iÃ§in ${remainingMinutes} dakika ${remainingSeconds} saniye beklemeniz gerekiyor!`,
            player.id,
            errorColor,
            "bold",
            2
        );
        return false // Komut devam etmesin, kalan sÃ¼reyi gÃ¶sterdik
    }

    // Son kullanÄ±m zamanÄ±nÄ± gÃ¼ncelle
    lastCall = now;

    
    room.sendAnnouncement(`Admin Ã§aÄŸrÄ±ldÄ±`, null, 0x1b02a3, "bold", 2);

    const reason = message.split(' ').slice(1).join(' ').trim();
    const finalReason = reason.length > 0 ? reason : "Sebep belirtilmedi.";    
    // Webhook ile Ã§aÄŸrÄ± yapma (isteÄŸe baÄŸlÄ±)
    let form = new FormData();
    form.append("payload_json", JSON.stringify({
        content: roleMentions, // Admin rol etiketleme
        username: "Admin Ã‡aÄŸrÄ± Sistemi",
        embeds: [{
            title: "ADMIN Ã‡AÄRISI",
            description: `\`[ ${roomName} ]\` odasÄ±nda admine ihtiyaÃ§ var.`,
            color: 3447003, // Embed rengi (hexa kodu)
            fields: [
                {
                    name: "**Ã‡aÄŸÄ±ran Oyuncu**",
                    value: `#${player.id} ${player.name}`,
                    inline: true
                },
                {
                    name: "**Sebep**",
                    value: finalReason,
                    inline: true
                },
                {
                    name: "**Oda Linki**",
                    value: `[Odaya BaÄŸlanmak Ä°Ã§in TÄ±kla](${roomLink})`,
                    inline: false
                }
            ],
            timestamp: new Date(),
        }],
        
    }));

    fetch(callWebhook, {
        method: 'POST',
        body: form,
    })
    .then((res) => {
        if (res.ok) {
        } else {
        }
    })
    .catch((err) => {
    });
}

/* LÄ°STE KONTROLÃœ */

// LS ile listeleri sync eden fonksiyonlar bulunur

function listeleriYÃ¼kle() {
    const loadedBanList = LocalListsStorage.getItem('banList');
    const loadedMasterList = LocalListsStorage.getItem('masterList');
    const loadedAdminList = LocalListsStorage.getItem('adminList');

    banList = loadedBanList ? JSON.parse(loadedBanList) : [];
    masterList = loadedMasterList ? JSON.parse(loadedMasterList) : [];
    adminList = loadedAdminList ? JSON.parse(loadedAdminList) : [];
}

function listeleriGÃ¼ncelle() {
    LocalListsStorage.setItem('banList', JSON.stringify(banList));
    LocalListsStorage.setItem('masterList', JSON.stringify(masterList));
    LocalListsStorage.setItem('adminList', JSON.stringify(adminList));
}

function listeleriYÃ¼kleYadaOluÅŸtur() {
    // Ban listesi kontrol ve yÃ¼kleme/oluÅŸturma
    if (LocalListsStorage.getItem('banList')) {
        banList = JSON.parse(LocalListsStorage.getItem('banList'));
    } else {
        LocalListsStorage.setItem('banList', JSON.stringify(banList));
    }

    // Master listesi kontrol ve yÃ¼kleme/oluÅŸturma
    if (LocalListsStorage.getItem('masterList')) {
        masterList = JSON.parse(LocalListsStorage.getItem('masterList'));
    } else {
        LocalListsStorage.setItem('masterList', JSON.stringify(masterList));
    }

    // Admin listesi kontrol ve yÃ¼kleme/oluÅŸturma
    if (LocalListsStorage.getItem('adminList')) {
        adminList = JSON.parse(LocalListsStorage.getItem('adminList'));
    } else {
        LocalListsStorage.setItem('adminList', JSON.stringify(adminList));
    }
}

/* OBJECTS */

class Goal {
    constructor(time, team, striker, assist) {
        this.time = time;
        this.team = team;
        this.striker = striker;
        this.assist = assist;
    }
}

class Game {
    constructor() {
        this.date = Date.now();
        this.scores = room.getScores();
        this.playerComp = getStartingLineups();
        this.goals = [];
        this.rec = room.startRecording();
        this.touchArray = [];
    }
}

class PlayerComposition {
    constructor(player, auth, timeEntry, timeExit) {
        this.player = player;
        this.auth = auth;
        this.timeEntry = timeEntry;
        this.timeExit = timeExit;
        this.inactivityTicks = 0;
        this.GKTicks = 0;
    }
}

class MutePlayer {
    constructor(name, id, auth) {
        this.id = MutePlayer.incrementId();
        this.name = name;
        this.playerId = id;
        this.auth = auth;
        this.unmuteTimeout = null;
    }

    static incrementId() {
        if (!this.latestId) this.latestId = 1
        else this.latestId++
        return this.latestId
    }

    setDuration(minutes) {
        this.unmuteTimeout = setTimeout(() => {
            room.sendAnnouncement(
                `ğŸ“¢ Susturulma cezan bitti.`,
                this.playerId,
                announcementColor,
                "bold",
                HaxNotification.CHAT
            );
            this.remove();
        }, minutes * 60 * 1000);
        muteArray.add(this);
    }

    remove() {
        this.unmuteTimeout = null;
        muteArray.removeById(this.id);
    }
}

class MuteList {
    constructor() {
        this.list = [];
    }

    add(mutePlayer) {
        this.list.push(mutePlayer);
        return mutePlayer;
    }

    getById(id) {
        var index = this.list.findIndex(mutePlayer => mutePlayer.id === id);
        if (index !== -1) {
            return this.list[index];
        }
        return null;
    }

    getByPlayerId(id) {
        var index = this.list.findIndex(mutePlayer => mutePlayer.playerId === id);
        if (index !== -1) {
            return this.list[index];
        }
        return null;
    }

    getByAuth(auth) {
        var index = this.list.findIndex(mutePlayer => mutePlayer.auth === auth);
        if (index !== -1) {
            return this.list[index];
        }
        return null;
    }

    removeById(id) {
        var index = this.list.findIndex(mutePlayer => mutePlayer.id === id);
        if (index !== -1) {
            this.list.splice(index, 1);
        }
    }

    removeByAuth(auth) {
        var index = this.list.findIndex(mutePlayer => mutePlayer.auth === auth);
        if (index !== -1) {
            this.list.splice(index, 1);
        }
    }
}

class BallTouch {
    constructor(player, time, goal, position) {
        this.player = player;
        this.time = time;
        this.goal = goal;
        this.position = position;
    }
}

class HaxStatistics {
    constructor(playerName = '') {
        this.playerName = playerName;
        this.games = 0;
        this.wins = 0;
        this.winrate = '0.00%';
        this.playtime = 0;
        this.goals = 0;
        this.assists = 0;
        this.CS = 0;
        this.ownGoals = 0;
    }
}

/* PLAYERS */

const Team = { SPECTATORS: 0, RED: 1, BLUE: 2 };
const State = { PLAY: 0, PAUSE: 1, STOP: 2 };
const Role = { PLAYER: 0, ADMIN_TEMP: 1, ADMIN_PERM: 2, MASTER: 3 };
const HaxNotification = { NONE: 0, CHAT: 1, MENTION: 2 };
const Situation = { STOP: 0, KICKOFF: 1, PLAY: 2, GOAL: 3 };

var gameState = State.STOP;
var playSituation = Situation.STOP;
var goldenGoal = false;

var playersAll = [];
var players = [];
var teamRed = [];
var teamBlue = [];
var teamSpec = [];

var teamRedStats = [];
var teamBlueStats = [];

var banList = [];

/* STATS */

var possession = [0, 0];
var actionZoneHalf = [0, 0];
var lastWinner = Team.SPECTATORS;
var streak = 0;

/* AUTH */

var authArray = [];
var adminList = [
    ['cDz3jGFWtU8OvYpHt34GS-bbVhAVq1Hfajk8jHqxfm8', 'dc: kgn.official'],
    // ['INSERT_AUTH_HERE', 'NICK_OF_ADMIN'],
    // ['INSERT_AUTH_HERE', 'NICK_OF_ADMIN'],
];
var masterList = [
    'cDz3jGFWtU8OvYpHt34GS-bbVhAVq1Hfajk8jHqxfm8', // Ã¶rnek auth verilmiÅŸtir.
    // 'INSERT_MASTER_AUTH_HERE'
    // 'INSERT_MASTER_AUTH_HERE'
    // 'INSERT_MASTER_AUTH_HERE'
];

/* Ä°SXXX FUNC */ 
function isMaster(player) {
    if (masterList.findIndex((auth) => auth == authArray[player.name][0]) != -1) {
        return true
    } else {
        return false
    }    
    
}
function isAdmin(player) {
    if (adminList.map((a) => a[0]).findIndex((auth) => auth == authArray[player.name][0]) != -1) {
        return true
    } else {
        return false
    }
}
function isSpecial (player) {
    if (isAdmin(player) || isMaster(player)) {
        return true
    } else {
        return false
    }
}
/* COMMANDS */



var commands = {
    komutlar: {
        aliases: ['cmds'],
        roles: Role.PLAYER,
        desc: true,
        function: helpCommand,
    },
    adminÃ§aÄŸÄ±r: {
        aliases: [],
        roles: Role.PLAYER,
        desc: true,
        function: callAdminCommand,
    },
    discord: {
        aliases: ['dc'],
        roles: Role.PLAYER,
        desc: true,
        function: dcLinkGÃ¶nder,
    },
    moderatorkomutlarÄ±: {
        aliases: [],
        roles: Role.ADMIN_PERM,
        desc: true,
        function: modCommands,
    },
    yÃ¶neticikomutlarÄ±: {
        aliases: [],
        roles: Role.MASTER,
        desc: true,
        function: yÃ¶neticiCommands,
    },
    kayÄ±t: {
        aliases: ['register'],
        roles: Role.PLAYER,
        desc: true,
        function: registerCommand,
    },
    giriÅŸ: {
        aliases: ['login'],
        roles: Role.PLAYER,
        desc: true,
        function: loginCommand,
    },
    yÃ¶neticikodum: {
        aliases: [],
        roles: Role.PLAYER,
        desc: false,
        function: masterCommand,
    },
    afk: {
        aliases: [],
        roles: Role.PLAYER,
        desc: true,
        function: afkCommand,
    },
    afklar: {
        aliases: ['afklistesi'],
        roles: Role.PLAYER,
        desc: true,
        function: afkListCommand,
    },
    bb: {
        aliases: ['bye'],
        roles: Role.PLAYER,
        desc: true,
        function: leaveCommand,
    },
    rank: {
        aliases: ['stat', 'stats'],
        roles: Role.PLAYER,
        desc: true,
        function: globalStatsCommand,
    },
    enÃ§okoynayanlar: {
        aliases: [],
        roles: Role.PLAYER,
        desc: true,
        function: statsLeaderboardCommand,
    },
    enÃ§okkazananlar: {
        aliases: [],
        roles: Role.PLAYER,
        desc: true,
        function: statsLeaderboardCommand,
    },
    golkrallÄ±ÄŸÄ±: {
        aliases: [],
        roles: Role.PLAYER,
        desc: true,
        function: statsLeaderboardCommand,
    },
    asistkrallÄ±ÄŸÄ±: {
        aliases: [],
        roles: Role.PLAYER,
        desc: true,
        function: statsLeaderboardCommand,
    },
    eniyikaleciler: {
        aliases: [],
        roles: Role.PLAYER,
        desc: true,
        function: statsLeaderboardCommand,
    },
    enaktifler: {
        aliases: [],
        roles: Role.PLAYER,
        desc: true,
        function: statsLeaderboardCommand,
    },
    antrenmanmap: {
        aliases: [],
        roles: Role.ADMIN_TEMP,
        desc: true,
        function: stadiumCommand,
    },
    kÃ¼Ã§Ã¼kmap: {
        aliases: [],
        roles: Role.ADMIN_TEMP,
        desc: true,
        function: stadiumCommand,
    },
    bÃ¼yÃ¼kmap: {
        aliases: [],
        roles: Role.ADMIN_TEMP,
        desc: true,
        function: stadiumCommand,
    },
    rr: {
        aliases: [],
        roles: Role.ADMIN_TEMP,
        desc: true,
        function: restartCommand,
    },
    rrs: {
        aliases: [],
        roles: Role.ADMIN_TEMP,
        desc: true,
        function: restartSwapCommand,
    },
    s: {
        aliases: ['s'],
        roles: Role.ADMIN_TEMP,
        desc: true,
        function: swapCommand,
    },
    kÄ±rmÄ±zÄ±takÄ±mÄ±at: {
        aliases: ['kickr'],
        roles: Role.ADMIN_TEMP,
        desc: true,
        function: kickTeamCommand,
    },
    mavitakÄ±mÄ±at: {
        aliases: ['kickb'],
        roles: Role.ADMIN_TEMP,
        desc: true,
        function: kickTeamCommand,
    },
    izleyicileriat: {
        aliases: ['kicks'],
        roles: Role.ADMIN_TEMP,
        desc: true,
        function: kickTeamCommand,
    },
    mute: {
        aliases: ['m'],
        roles: Role.ADMIN_TEMP,
        desc: true,
        function: muteCommand,
    },
    mutekaldÄ±r: {
        aliases: ['unmute'],
        roles: Role.ADMIN_TEMP,
        desc: true,
        function: unmuteCommand,
    },
    muteliler: {
        aliases: [],
        roles: Role.ADMIN_TEMP,
        desc: true,
        function: muteListCommand,
    },
    banlarÄ±temizle: {
        aliases: [],
        roles: Role.MASTER,
        desc: true,
        function: clearbansCommand,
    },
    banlÄ±lar: {
        aliases: ['banlistesi'],
        roles: Role.MASTER,
        desc: true,
        function: banListCommand,
    },
    moderatorler: {
        aliases: ['moderatorlistesi','modlar'],
        roles: Role.MASTER,
        desc: true,
        function: adminListCommand,
    },
    modver: {
        aliases: ['moderatorekle'],
        roles: Role.MASTER,
        desc: true,
        function: setAdminCommand,
    },
    modsil: {
        aliases: ['moderatorsil'],
        roles: Role.MASTER,
        desc: true,
        function: removeAdminCommand,
    },
    ÅŸifre: {
        aliases: ['password'],
        roles: Role.MASTER,
        desc: true,
        function: passwordCommand,
    },
};


/* GAME */

var lastTouches = Array(2).fill(null);
var lastTeamTouched;

var speedCoefficient = 100 / (5 * (0.99 ** 60 + 1));
var ballSpeed = 0;
var playerRadius = 15;
var ballRadius = 5.8;
var triggerDistance = playerRadius + ballRadius + 0.01;

/* RENKLER */

var yÃ¶neticiColor = 0x5d918c
var moderatorColor = 0x5c8759
var welcomeColor = 0x03fe69
var announcementColor = 0xffefd6;
var infoColor = 0xffffff
var redColor = 0x9c2f2f;
var blueColor = 0x344185
var warningColor = 0xffa135;
var errorColor = 0xb50000;
var successColor = 0x2bd92b;
var defaultColor = null;

/* AUXILIARY */

var checkTimeVariable = false;
var checkStadiumVariable = true;
var endGameVariable = false;
var cancelGameVariable = false;
var kickFetchVariable = false;

var chooseMode = false;
var timeOutCap;
var capLeft = false;
var redCaptainChoice = '';
var blueCaptainChoice = '';
var chooseTime = 20;

var AFKSet = new Set();
var AFKMinSet = new Set();
var AFKCooldownSet = new Set();

var muteArray = new MuteList();
var muteDuration = 5;

var removingPlayers = false;
var insertingPlayers = false;

var stopTimeout;
var startTimeout;
var unpauseTimeout;
var removingTimeout;
var insertingTimeout;

var emptyPlayer = {
    id: 0,
};
stadiumCommand(emptyPlayer, "!antrenmanmap");

var game = new Game();

/* FUNCTIONS */

function findRegisteredUser(player) {
    // LocalStorage'dan player bilgisi kontrol edilir.
    let playerData = LocalProfilesStorage.getItem(player.name); 
    if (playerData) {
        playerData = JSON.parse(playerData);  // JSON string'i objeye Ã§evir
        return playerData.name;
    }
    return undefined;
}

function isInTheLimits(input, min, max) {
    return min <= input && input <= max;
}

function onJoinProfile(player) {
    // LocalStorage'dan oyuncu verisini kontrol et
    let playerData = LocalProfilesStorage.getItem(player.name);
    if (playerData) {
        playerData = JSON.parse(playerData);  // JSON string'i objeye Ã§evir
    }

    if (!playerData) {
        var otherUserName = findRegisteredUser(player);
        if (otherUserName == undefined) {
            setTimeout(function() {
                room.sendAnnouncement(`ğŸ” ğ—ğ—”ğ—¬ğ—œğ—§ á´ÊŸá´á´€á´¢sá´€É´Éªá´¢ ${loginTimeout} êœ±á´€É´ÉªÊá´‡ Éªá´„á´‡Ê€Éªêœ±ÉªÉ´á´…á´‡ á´€á´›ÉªÊŸá´€á´„á´€á´‹êœ±ÉªÉ´Éªá´¢. ğŸ’ ğ—ğ—”ğ—¬ğ—œğ—§ Éªá´„ÉªÉ´ !kayÄ±t ÅŸifre`, player.id, darkBlue, "bold", 2);
            }, 3000);
            setTimeout(function() {
                room.sendAnnouncement(`ğŸ” ğ—ğ—”ğ—¬ğ—œğ—§ á´ÊŸá´á´€á´¢sá´€É´Éªá´¢ ${loginTimeout} êœ±á´€É´ÉªÊá´‡ Éªá´„á´‡Ê€Éªêœ±ÉªÉ´á´…á´‡ á´€á´›ÉªÊŸá´€á´„á´€á´‹êœ±ÉªÉ´Éªá´¢. ğŸ’ ğ—ğ—”ğ—¬ğ—œğ—§ Éªá´„ÉªÉ´ !kayÄ±t ÅŸifre`, player.id, darkBlue, "bold", 2);
            }, 5000);
            setTimeout(function() {
                if (!LocalProfilesStorage.getItem(player.name)) {
                    room.kickPlayer(player.id, "KaydolmadÄ±n. '!kayÄ±t ÅŸifre' kullanarak kaydolun", false);
                }
            }, loginTimeout * 1000);
        } else {
            room.kickPlayer(player.id, `BaÅŸka bir isimle kaydolmuÅŸsun. Hesap AdÄ±: ${otherUserName}`, false);
        }
    } else {
        if (player.auth === playerData.auth) {
            room.sendAnnouncement(`ğŸ” ${player.name}, á´‹Éªá´ÊŸÉªá´‹ á´…á´É¢Ê€á´œÊŸá´€á´á´€ Ê™á´€sá´€Ê€ÉªÊŸÉª.`, player.id, 0x00FF00, "bold", 1);
            playerData.loggedIn = true;
            LocalProfilesStorage.setItem(player.name, JSON.stringify(playerData));  // Objeyi JSON string olarak kaydediyorum :p
        } else {
            setTimeout(function() {
                room.sendAnnouncement(`ğŸ” ${loginTimeout} sá´€É´ÉªÊá´‡ Éªá´„ÉªÉ´á´…á´‡ ğ—šğ—œğ—¥ğ—œğ—¦ Êá´€á´˜á´á´€ÊŸÉªsÉªÉ´Éªá´¢. ğŸ’ ğ—šğ—œğ—¥ğ—œğ—¦ Éªá´„ÉªÉ´ !giriÅŸ ÅŸifre`, player.id, lightBlue, "bold", 2);
            }, 2000);
            setTimeout(function() {
                room.sendAnnouncement(`ğŸ” ${loginTimeout} sá´€É´ÉªÊá´‡ Éªá´„ÉªÉ´á´…á´‡ ğ—šğ—œğ—¥ğ—œğ—¦ Êá´€á´˜á´á´€ÊŸÉªsÉªÉ´Éªá´¢. ğŸ’ ğ—šğ—œğ—¥ğ—œğ—¦ Éªá´„ÉªÉ´ !giriÅŸ ÅŸifre`, player.id, lightBlue, "bold", 2);
            }, 5000);
            setTimeout(function() {
                let updprofile = LocalProfilesStorage.getItem(player.name)
                if (updprofile.loggedIn === false) {
                    room.kickPlayer(player.id, "GiriÅŸ yapmadÄ±nÄ±z. '!giriÅŸ ÅŸifre' kullanarak giriÅŸ yapÄ±n.", false);
                } else {
                    LocalProfilesStorage.setItem(player.name, JSON.stringify(playerData)); 
                }
            }, loginTimeout * 1000);
        }
    }
}

function registerCommand(player, message) {
    var splitted = message.split(" ");
    if (splitted.length == 2) {
        var password = splitted[1];
        if (LocalProfilesStorage.getItem(player.name)) {
            room.sendAnnouncement(`ğŸ” ${player.name}, á´¢á´€á´›á´‡É´ á´‹á´€ÊÄ±á´›ÊŸÄ±êœ±Ä±É´.`, player.id, errorColor, "bold", 2);
            return false
        }
        if (isInTheLimits(password.length, passwordLengths.min, passwordLengths.max)) {
            room.sendAnnouncement(`ğŸ” ${player.name}, á´‹á´€ÊÉªá´› Ê™á´€êœ±á´€Ê€ÉªÊŸÉª. êœ±Éªêœ°Ê€á´‡É´: ${password}`, player.id, successColor, "bold", 1);

            // KullanÄ±cÄ±yÄ± LocalStorage'a kaydet
            var playerData = {
                name: player.name,
                auth: authArray[player.name][0], // authArray'deki bilgiyi al
                conn: authArray[player.name][1], // conn bilgisi
                password: password,
                registered: true,
                loggedIn: true
            };
            LocalProfilesStorage.setItem(player.name, JSON.stringify(playerData));  // json olarak kaydediyorum 

            return false;
        } else {
            room.sendAnnouncement(`âš ï¸ êœ±Éªêœ°Ê€á´‡É´ á´ÉªÉ´ ${passwordLengths.min}, á´á´€x ${passwordLengths.max} Êœá´€É´á´‡ á´ÊŸá´á´€ÊŸÄ±á´…Ä±Ê€.`, player.id, errorColor, "bold", 2);
            return false;
        }
    } else { 
        room.sendAnnouncement("âš ï¸ Êá´€É´ÊŸÉªêœ± á´‹á´á´á´œá´› á´‹á´œÊŸÊŸá´€É´Éªá´Éª. ğŸ’ ğ—ğ—”ğ—¬ğ—œğ—§ Éªá´„ÉªÉ´ !kayÄ±t ÅŸifre", player.id, errorColor, "bold", 2);
        return false;
    }
}

function loginCommand(player, message) {
    var splitted = message.split(" ");
    var playerData = LocalProfilesStorage.getItem(player.name);

    if (!playerData) {
        room.sendAnnouncement("âš ï¸ á´É´á´„á´‡ á´‹á´€ÊÉªá´› á´ÊŸá´á´€ÊŸÉªêœ±ÉªÉ´. ğŸ’ ğ—ğ—”ğ—¬ğ—œğ—§ Éªá´„ÉªÉ´ !kayÄ±t ÅŸifre", player.id,errorColor, "bold", 2);
        return false;
    }

    playerData = JSON.parse(playerData);  // JSON string'i objeye Ã§eviren kodumuzz

    if (playerData.loggedIn == false) {
        if (splitted.length == 2) {
            var password = splitted[1];
            if (password === playerData.password) {
                room.sendAnnouncement(`ğŸ” ${player.name}, á´‹Éªá´ÊŸÉªá´‹ á´…á´É¢Ê€á´œÊŸá´€á´á´€ Ê™á´€sá´€Ê€ÉªÊŸÉª.`, player.id, successColor, "bold", 1);
                playerData.loggedIn = true;
                LocalProfilesStorage.setItem(player.name, JSON.stringify(playerData));  
            } else {
                room.sendAnnouncement("âš ï¸ á´‹á´œÊŸÊŸá´€É´Éªá´„Éª á´€á´…Éª / êœ±ÉªÒ“Ê€á´‡ Êá´€É´ÊŸÉªêœ± !", player.id, errorColor, "bold", 2);
            }
        } else {
            room.sendAnnouncement("âš ï¸ êœ±Ä±êœ°Ê€á´‡É´ Ê™á´êœ±ÊŸá´œá´‹ Ä±á´„á´‡Ê€á´‡á´á´‡á´¢", player.id, errorColor, "bold", 2);
        }
    } else {
        room.sendAnnouncement(`ğŸ” ${player.name}, á´‹Éªá´ÊŸÉªá´‹ á´¢á´€á´›á´‡É´ á´…á´É¢Ê€á´œÊŸá´€É´á´…Ä±.`, player.id, errorColor, "bold", 2);
    }
}


/* AUXILIARY FUNCTIONS */

if (typeof String.prototype.replaceAll != 'function') {
    String.prototype.replaceAll = function (search, replacement) {
        var target = this;
        return target.split(search).join(replacement);
    };
}

function getDate() {
    let d = new Date();
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
}

/* MATH FUNCTIONS */

function getRandomInt(max) {
    // 0-1 arasÄ±nda rastgele sayÄ±
    return Math.floor(Math.random() * Math.floor(max));
}

function pointDistance(p1, p2) {
    return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
}

/* TIME FUNCTIONS */

function getHoursStats(time) {
    return Math.floor(time / 3600);
}

function getMinutesGame(time) {
    var t = Math.floor(time / 60);
    return `${Math.floor(t / 10)}${Math.floor(t % 10)}`;
}

function getMinutesReport(time) {
    return Math.floor(Math.round(time) / 60);
}

function getMinutesEmbed(time) {
    var t = Math.floor(Math.round(time) / 60);
    return `${Math.floor(t / 10)}${Math.floor(t % 10)}`;
}

function getMinutesStats(time) {
    return Math.floor(time / 60) - getHoursStats(time) * 60;
}

function getSecondsGame(time) {
    var t = Math.floor(time - Math.floor(time / 60) * 60);
    return `${Math.floor(t / 10)}${Math.floor(t % 10)}`;
}

function getSecondsReport(time) {
    var t = Math.round(time);
    return Math.floor(t - getMinutesReport(t) * 60);
}

function getSecondsEmbed(time) {
    var t = Math.round(time);
    var t2 = Math.floor(t - Math.floor(t / 60) * 60);
    return `${Math.floor(t2 / 10)}${Math.floor(t2 % 10)}`;
}

function getTimeGame(time) {
    return `[${getMinutesGame(time)}:${getSecondsGame(time)}]`;
}

function getTimeEmbed(time) {
    return `[${getMinutesEmbed(time)}:${getSecondsEmbed(time)}]`;
}

function getTimeStats(time) {
    if (getHoursStats(time) > 0) {
        return `${getHoursStats(time)} saat ${getMinutesStats(time)} dakika`;
    } else {
        return `${getMinutesStats(time)} dakika`;
    }
}

function getGoalGame() {
    return game.scores.red + game.scores.blue;
}

/* REPORT FUNCTIONS */

function findFirstNumberCharString(str) {
    let str_number = str[str.search(/[0-9]/g)];
    return str_number === undefined ? "0" : str_number;
}

function getIdReport() {
    var d = new Date();
    return `${d.getFullYear() % 100}${d.getMonth() < 9 ? '0' : ''}${d.getMonth() + 1}${d.getDate() < 10 ? '0' : ''}${d.getDate()}${d.getHours() < 10 ? '0' : ''}${d.getHours()}${d.getMinutes() < 10 ? '0' : ''}${d.getMinutes()}${d.getSeconds() < 10 ? '0' : ''}${d.getSeconds()}${findFirstNumberCharString(roomName)}`;
}

function getRecordingName(game) {
    let d = new Date();
    let redCap = game.playerComp[0][0] != undefined ? game.playerComp[0][0].player.name : 'Red';
    let blueCap = game.playerComp[1][0] != undefined ? game.playerComp[1][0].player.name : 'Blue';
    let day = d.getDate() < 10 ? '0' + d.getDate() : d.getDate();
    let month = d.getMonth() < 10 ? '0' + (d.getMonth() + 1) : (d.getMonth() + 1);
    let year = d.getFullYear() % 100 < 10 ? '0' + (d.getFullYear() % 100) : (d.getFullYear() % 100);
    let hour = d.getHours() < 10 ? '0' + d.getHours() : d.getHours();
    let minute = d.getMinutes() < 10 ? '0' + d.getMinutes() : d.getMinutes();
    return `${day}-${month}-${year}-${hour}-${minute}-${redCap}-${blueCap}.hbr2`;
}

function fetchRecording(game) {
    if (gameWebhook != "") {
        let form = new FormData();
        form.append(null, new File([game.rec], getRecordingName(game), { "type": "text/plain" }));
        form.append("payload_json", JSON.stringify({
            "username": " Bot"
        }));

        fetch(gameWebhook, {
            method: 'POST',
            body: form,
        }).then((res) => res);
    }
}

/* FEATURE FUNCTIONS */

function getCommand(commandStr) {
    if (commands.hasOwnProperty(commandStr)) return commandStr;
    for (const [key, value] of Object.entries(commands)) {
        for (let alias of value.aliases) {
            if (alias == commandStr) return key;
        }
    }
    return false;
}

function getPlayerComp(player) {
    if (player == null || player.id == 0) return null;
    var comp = game.playerComp;
    var index = comp[0].findIndex((c) => c.auth == authArray[player.name][0]);
    if (index != -1) return comp[0][index];
    index = comp[1].findIndex((c) => c.auth == authArray[player.name][0]);
    if (index != -1) return comp[1][index];
    return null;
}

function getTeamArray(team, includeAFK = true) {
    if (team == Team.RED) return teamRed;
    if (team == Team.BLUE) return teamBlue;
    if (includeAFK) {
      return playersAll.filter((p) => p.team === Team.SPECTATORS);
    }
    return teamSpec;
}

function sendAnnouncementTeam(message, team, color, style, mention) {
    for (let player of team) {
        room.sendAnnouncement(message, player.id, color, style, mention);
    }
}

function teamChat(player, message) {
    var msgArray = message.split(/ +/).slice(1);
    var message = `ã€Œğ—§ã€${player.name}: ${msgArray.join(' ')}`;
    var team = getTeamArray(player.team, true);
    var color = player.team == Team.RED ? redColor : player.team == Team.BLUE ? blueColor : null;
    var style = 'bold';
    var mention = HaxNotification.CHAT;
    sendAnnouncementTeam(message, team, color, style, mention);
}

/* PHYSICS FUNCTIONS */

function calculateStadiumVariables() {
    if (checkStadiumVariable && teamRed.length + teamBlue.length > 0) {
        checkStadiumVariable = false;
        setTimeout(() => {
            let ballDisc = room.getDiscProperties(0);
            let playerDisc = room.getPlayerDiscProperties(teamRed.concat(teamBlue)[0].id);
            ballRadius = ballDisc.radius;
            playerRadius = playerDisc.radius;
            triggerDistance = ballRadius + playerRadius + 0.01;
            speedCoefficient = 100 / (5 * ballDisc.invMass * (ballDisc.damping ** 60 + 1));
        }, 1);
    }
}

function checkGoalKickTouch(array, index, goal) {
    if (array != null && array.length >= index + 1) {
        var obj = array[index];
        if (obj != null && obj.goal != null && obj.goal == goal) return obj;
    }
    return null;
}

/* BUTTONS */

function topButton() {
    if (teamSpec.length > 0) {
        if (teamRed.length == teamBlue.length && teamSpec.length > 1) {
            room.setPlayerTeam(teamSpec[0].id, Team.RED);
            room.setPlayerTeam(teamSpec[1].id, Team.BLUE);
        } else if (teamRed.length < teamBlue.length)
            room.setPlayerTeam(teamSpec[0].id, Team.RED);
        else room.setPlayerTeam(teamSpec[0].id, Team.BLUE);
    }
}

function randomButton() {
    if (teamSpec.length > 0) {
        if (teamRed.length == teamBlue.length && teamSpec.length > 1) {
            var r = getRandomInt(teamSpec.length);
            room.setPlayerTeam(teamSpec[r].id, Team.RED);
            teamSpec = teamSpec.filter((spec) => spec.id != teamSpec[r].id);
            room.setPlayerTeam(teamSpec[getRandomInt(teamSpec.length)].id, Team.BLUE);
        } else if (teamRed.length < teamBlue.length)
            room.setPlayerTeam(teamSpec[getRandomInt(teamSpec.length)].id, Team.RED);
        else
            room.setPlayerTeam(teamSpec[getRandomInt(teamSpec.length)].id, Team.BLUE);
    }
}

function blueToSpecButton() {
    clearTimeout(removingTimeout);
    removingPlayers = true;
    removingTimeout = setTimeout(() => {
        removingPlayers = false;
    }, 100);
    for (var i = 0; i < teamBlue.length; i++) {
        room.setPlayerTeam(teamBlue[teamBlue.length - 1 - i].id, Team.SPECTATORS);
    }
}

function redToSpecButton() {
    clearTimeout(removingTimeout);
    removingPlayers = true;
    removingTimeout = setTimeout(() => {
        removingPlayers = false;
    }, 100);
    for (var i = 0; i < teamRed.length; i++) {
        room.setPlayerTeam(teamRed[teamRed.length - 1 - i].id, Team.SPECTATORS);
    }
}

function resetButton() {
    clearTimeout(removingTimeout);
    removingPlayers = true;
    removingTimeout = setTimeout(() => {
        removingPlayers = false;
    }, 100);
    for (let i = 0; i < Math.max(teamRed.length, teamBlue.length); i++) {
        if (Math.max(teamRed.length, teamBlue.length) - teamRed.length - i > 0)
            room.setPlayerTeam(teamBlue[teamBlue.length - 1 - i].id, Team.SPECTATORS);
        else if (Math.max(teamRed.length, teamBlue.length) - teamBlue.length - i > 0)
            room.setPlayerTeam(teamRed[teamRed.length - 1 - i].id, Team.SPECTATORS);
        else break;
    }
    for (let i = 0; i < Math.min(teamRed.length, teamBlue.length); i++) {
        room.setPlayerTeam(
            teamBlue[Math.min(teamRed.length, teamBlue.length) - 1 - i].id,
            Team.SPECTATORS
        );
        room.setPlayerTeam(
            teamRed[Math.min(teamRed.length, teamBlue.length) - 1 - i].id,
            Team.SPECTATORS
        );
    }
}

function swapButton() {
    clearTimeout(removingTimeout);
    removingPlayers = true;
    removingTimeout = setTimeout(() => {
        removingPlayers = false;
    }, 100);
    for (let player of teamBlue) {
        room.setPlayerTeam(player.id, Team.RED);
    }
    for (let player of teamRed) {
        room.setPlayerTeam(player.id, Team.BLUE);
    }
}

/* COMMAND FUNCTIONS */

/* PLAYER COMMANDS */

function leaveCommand(player, message) {
    room.kickPlayer(player.id, 'GÃ¶rÃ¼ÅŸÃ¼rÃ¼z !', false);
}

function helpCommand(player, message) {
    var msgArray = message.split(/ +/).slice(1);
    if (msgArray.length == 0) {
        var commandString = 'ğŸ”· ğ—ğ—¢ğ— ğ—¨ğ—§ğ—Ÿğ—”ğ—¥: ';
        // Oyuncu komutlarÄ±nÄ± ekle
        for (const [key, value] of Object.entries(commands)) {
            if (value.desc && value.roles == Role.PLAYER) {
                commandString += ` !${key},`;
            }
        }
        commandString = commandString.substring(0, commandString.length - 1) + '.\n';

        // Admin kontrolÃ¼ (admin komutlarÄ±nÄ± gÃ¶rmek iÃ§in mesaj)
        if (getRole(player) >= Role.ADMIN_TEMP) {
            commandString += `ğŸ”· ModeratÃ¶r komutlarÄ±nÄ± gÃ¶rmek iÃ§in !moderatorkomutlarÄ± kullan.\n`;
        }

        // Master kontrolÃ¼ (master komutlarÄ±nÄ± gÃ¶rmek iÃ§in mesaj)
        if (getRole(player) >= Role.MASTER) {
            commandString += `ğŸ”· YÃ¶netici komutlarÄ±nÄ± gÃ¶rmek iÃ§in !yÃ¶neticikomutlarÄ± kullan.`;
        }

        room.sendAnnouncement(
            commandString,
            player.id,
            successColor,
            'normal',
            HaxNotification.CHAT
        );
    }
}
function modCommands(player, message) {
    if (getRole(player) >= Role.ADMIN_TEMP) {
        var commandString = 'ğŸ”· ğ— ğ—¢ğ——ğ—˜ğ—¥ğ—”ğ—§ğ—¢ğ—¥ ğ—ğ—¢ğ— ğ—¨ğ—§ğ—Ÿğ—”ğ—¥ğ—œ: ';
        for (const [key, value] of Object.entries(commands)) {
            if (value.desc && value.roles == Role.ADMIN_TEMP) {
                commandString += ` !${key},`;
            }
        }
        if (commandString.slice(commandString.length - 1) == ':') {
            commandString += ' None,';
        }
        commandString = commandString.substring(0, commandString.length - 1) + '.';
        room.sendAnnouncement(
            commandString,
            player.id,
            successColor,
            'normal',
            HaxNotification.CHAT
        );
    }
}

function yÃ¶neticiCommands(player, message) {
    if (getRole(player) >= Role.MASTER) {
        var commandString = 'ğŸ”· ğ—¬ğ—¢ğ—¡ğ—˜ğ—§ğ—œğ—–ğ—œ ğ—ğ—¢ğ— ğ—¨ğ—§ğ—Ÿğ—”ğ—¥ğ—œ: ';
        for (const [key, value] of Object.entries(commands)) {
            if (value.desc && value.roles == Role.MASTER) {
                commandString += ` !${key},`;
            }
        }
        if (commandString.slice(commandString.length - 1) == ':') {
            commandString += ' None,';
        }
        commandString = commandString.substring(0, commandString.length - 1) + '.';
        room.sendAnnouncement(
            commandString,
            player.id,
            successColor,
            'normal',
            HaxNotification.CHAT
        );
    }
}

function rutbeCommand(player) {
    let stats = new HaxStatistics(player.name);
    
    // EÄŸer player'Ä±n local stats'leri varsa, yÃ¼kle
    if (LocalStatsStorage.getItem(player.name)) {
        stats = JSON.parse(LocalStatsStorage.getItem(player.name));
    }

    // EÄŸer oyuncunun istatistikleri yoksa veya puanÄ± 0 ise "á´‹á´€ÊÉªá´›êœ±Éªá´¢" dÃ¶n
    if (!stats || stats.games === 0) {
        return "Ê€á´œá´›Ê™á´‡êœ±Éªá´¢";
    }

    // Yenilgiyi ve PuanÄ± hesapla
    let losses = stats.games - stats.wins;
    let points = (stats.wins * 15) + (losses * -10) + (stats.goals * 5) + (stats.assists * 3) + (stats.ownGoals * -3) + (stats.CS * 5);

    // RÃ¼tbe hesaplama
    let rank = '';
    if (points <= 500) {
        rank = 'á´€É¢ÉªÊ€ á´€á´„á´‡á´Éª';
    } else if (points <= 1000) {
        rank = 'á´€á´„á´‡á´Éª';
    } else if (points <= 2000) {
        rank = 'á´Ê€á´›á´€';
    } else if (points <= 5000) {
        rank = 'á´˜Ê€á´';
    } else if (points <= 10000000) {
        rank = 'Êœá´˜';
    } else {
        rank = "Ê€á´œá´›Ê™á´‡êœ±Éªá´¢";
    }

    return rank;
}


function globalStatsCommand(player, message) {
    var stats = new HaxStatistics(player.name);
    
    // EÄŸer player'Ä±n local stats'leri varsa, yÃ¼kle
    if (LocalStatsStorage.getItem(player.name)) {
        stats = JSON.parse(LocalStatsStorage.getItem(player.name));
    }

    if (!stats) {
        room.sendAnnouncement(
            "âš ï¸ Yeterince oyun oynamadÄ±n.",
            player.id,
            errorColor,
            'bold',
            2
        );
        return false
    }

    // Yenilgiyi ve PuanÄ± hesapla
    let losses = stats.games - stats.wins;
    let points = (stats.wins * 15) + (losses * -10) + (stats.goals * 5) + (stats.assists * 3) + (stats.ownGoals * -3) + (stats.CS * 5);
    
    // Galibiyet oranÄ±nÄ± hesapla
    let winrate = ((stats.wins / stats.games) * 100).toFixed(2);

    // TÃ¼m oyuncularÄ± localStorage'dan al ve sÄ±ralama yap
    let leaderboard = [];
    for (let i = 0; i < LocalStatsStorage.length; i++) {
        let key = LocalStatsStorage.key(i); // AnahtarÄ± al
        let playerStats = JSON.parse(LocalStatsStorage.getItem(key)); // AnahtarÄ± kullanarak veriyi al
    
        // Verinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± kontrol et
        if (playerStats && playerStats.playerName) {
            let losses = playerStats.games - playerStats.wins;
            let points = (playerStats.wins * 15) + (losses * -10) + (playerStats.goals * 5) + (playerStats.assists * 3) + (playerStats.ownGoals * -3) + (playerStats.CS * 5);
    
            leaderboard.push({ playerName: playerStats.playerName, points: points });
        }
    }
    
    // SÄ±ralama yap
    leaderboard.sort((a, b) => b.points - a.points);
    
    // SÄ±ralamada oyuncunun yerini bul
    let rank = leaderboard.findIndex(player => player.playerName === stats.playerName) + 1; // oyuncunun adÄ±nÄ± kullanarak sÄ±ralamayÄ± bul
    

    // Output formatÄ±
    let statsString = 
`ğŸ“ˆ@${stats.playerName}ãƒ»âš½ï¸Galibiyet: ${stats.wins}ãƒ»ğŸ”»MaÄŸlubiyet: ${losses}ãƒ»âš½Gol: ${stats.goals}ãƒ»ğŸ‘ŸAss: ${stats.assists}
ğŸ“ˆ@${stats.playerName}ãƒ»âš½ï¸${stats.games} MaÃ§ãƒ»ğŸ”°%${winrate} Galibiyet OranÄ±ãƒ»ğŸ˜¢á´‹á´‹: ${stats.ownGoals}ãƒ»ğŸ§¤CS: ${stats.CS}
ğŸ“ˆ@${stats.playerName}ãƒ»ğŸ…¿ï¸PuanÄ±n: ${points} ãƒ» ğŸ†SÄ±ralaman: ${rank}/${leaderboard.length} ãƒ» Ê€á´œá´›Ê™á´‡É´: ${rutbeCommand(player)}`;

    // Duyuru yap
    room.sendAnnouncement(
        statsString,
        null,
        0xb1bff9,
        'bold',
        2
    );
}

function statsLeaderboardCommand(player, message) {
    var commandMap = {
        "enÃ§okoynayanlar": "games",
        "enÃ§okkazananlar": "wins",
        "golkrallÄ±ÄŸÄ±": "goals",
        "asistkrallÄ±ÄŸÄ±": "assists",
        "eniyikaleciler": "CS",
        "enaktifler": "playtime"
    };
    var key = message.split(/ +/)[0].substring(1).toLowerCase();
    printRankings(commandMap[key], player.id);
}

function afkCommand(player, message) {
    if (player.team == Team.SPECTATORS || players.length == 1) {
        if (AFKSet.has(player.id)) {
            if (AFKMinSet.has(player.id)) {
                room.sendAnnouncement(
                    `âš ï¸ Minimum ${minAFKDuration} dakika AFK kalmalÄ±sÄ±n !`,
                    player.id,
                    errorColor,
                    'bold',
                    HaxNotification.CHAT
                );
            } else {
                AFKSet.delete(player.id);
                room.sendAnnouncement(
                    `ğŸ¥± ${player.name} artÄ±k AFK deÄŸil !`,
                    null,
                    announcementColor,
                    'bold',
                    null
                );
                updateTeams();
                handlePlayersJoin();
            }
        } else {
            if (AFKCooldownSet.has(player.id)) {
                room.sendAnnouncement(
                    `âš ï¸ Sadece her ${AFKCooldown} dakikada bir AFK kalabilirsin !`,
                    player.id,
                    errorColor,
                    'bold',
                    HaxNotification.CHAT
                );
            } else {
                AFKSet.add(player.id);
                if (!player.admin) {
                    AFKMinSet.add(player.id);
                    AFKCooldownSet.add(player.id);
                    setTimeout(
                        (id) => {
                            AFKMinSet.delete(id);
                        },
                        minAFKDuration * 60 * 1000,
                        player.id
                    );
                    setTimeout(
                        (id) => {
                            AFKSet.delete(id);
                        },
                        maxAFKDuration * 60 * 1000,
                        player.id
                    );
                    setTimeout(
                        (id) => {
                            AFKCooldownSet.delete(id);
                        },
                        AFKCooldown * 60 * 1000,
                        player.id
                    );
                }
                room.setPlayerTeam(player.id, Team.SPECTATORS);
                room.sendAnnouncement(
                    `ğŸ˜´ ${player.name} AFK !`,
                    null,
                    announcementColor,
                    'bold',
                    null
                );
                updateTeams();
                handlePlayersLeave();
            }
        }
    } else {
        room.sendAnnouncement(
            `âš ï¸ Bir takÄ±mdayken AFK kalamazsÄ±n !`,
            player.id,
            errorColor,
            'bold',
            HaxNotification.CHAT
        );
    }
}

function afkListCommand(player, message) {
    if (AFKSet.size == 0) {
        room.sendAnnouncement(
            "ğŸ˜´ AFK oyuncu yok.",
            player.id,
            announcementColor,
            'bold',
            null
        );
        return;
    }
    var cstm = 'ğŸ˜´ AFK Oyuncular : ';
    AFKSet.forEach((_, value) => {
        var p = room.getPlayer(value);
        if (p != null) cstm += p.name + `, `;
    });
    cstm = cstm.substring(0, cstm.length - 2) + '.';
    room.sendAnnouncement(cstm, player.id, announcementColor, 'bold', null);
}

function masterCommand(player, message) {
    var msgArray = message.split(/ +/).slice(1);
    if (parseInt(msgArray[0]) == masterPassword) {
        if (!masterList.includes(authArray[player.name][0])) {
            room.setPlayerAdmin(player.id, true);
            adminList = adminList.filter((a) => a[0] != authArray[player.name][0]);
            masterList.push(authArray[player.name][0]);
            room.sendAnnouncement(
                `ğŸŒ ${player.name} isimli oyuncuya YÃ–NETÄ°CÄ° yetkisi verildi.`,
                null,
                announcementColor,
                'bold',
                HaxNotification.CHAT
            );
        } else {
            room.sendAnnouncement(
                `âš ï¸ Zaten YÃ–NETÄ°CÄ° yetkin var.`,
                player.id,
                errorColor,
                'bold',
                HaxNotification.CHAT
            );
        }
    }
    listeleriGÃ¼ncelle()    
}

/* ADMIN COMMANDS */

function restartCommand(player, message) {
    instantRestart();
}

function restartSwapCommand(player, message) {
    room.stopGame();
    swapButton();
    startTimeout = setTimeout(() => {
        room.startGame();
    }, 10);
}

function swapCommand(player, message) {
    if (playSituation == Situation.STOP) {
        swapButton();
        room.sendAnnouncement(
            'âœ… TakÄ±mlar deÄŸiÅŸtirildi.',
            null,
            announcementColor,
            'bold',
            null
        );
    } else {
        room.sendAnnouncement(
            `âš ï¸ Bu komutu kullanmadan Ã¶nce oyunu durdurmalÄ±sÄ±n.`,
            player.id,
            errorColor,
            'bold',
            HaxNotification.CHAT
        );
    }
}

function kickTeamCommand(player, message) {
    var msgArray = message.split(/ +/);
    var reasonString = `TakÄ±m ${player.name} isimli yetkili tarafÄ±ndan atÄ±ldÄ±.`;
    if (msgArray.length > 1) {
        reasonString = msgArray.slice(1).join(' ');
    }
    if (['!kÄ±rmÄ±zÄ±takÄ±mÄ±at', '!kickr'].includes(msgArray[0].toLowerCase())) {
        for (let i = 0; i < teamRed.length; i++) {
            setTimeout(() => {
                room.kickPlayer(teamRed[0].id, reasonString, false);
            }, i * 20)
        }
    } else if (['!mavitakÄ±mÄ±at', '!kickb'].includes(msgArray[0].toLowerCase())) {
        for (let i = 0; i < teamBlue.length; i++) {
            setTimeout(() => {
                room.kickPlayer(teamBlue[0].id, reasonString, false);
            }, i * 20)
        }
    } else if (['!izleyicileriat', '!kicks'].includes(msgArray[0].toLowerCase())) {
        for (let i = 0; i < teamSpec.length; i++) {
            setTimeout(() => {
                room.kickPlayer(teamSpec[0].id, reasonString, false);
            }, i * 20)
        }
    }
}

function stadiumCommand(player, message) {
    var msgArray = message.split(/ +/);
    if (gameState == State.STOP) {
        if (['!kÃ¼Ã§Ã¼kmap'].includes(msgArray[0].toLowerCase())) {
            room.setCustomStadium(classicMap);
            room.sendAnnouncement("âœ”ï¸ v1-v2 Futsal á´€á´„ÉªÊŸÉªÊá´Ê€.",null,successColor,"bold",1)
            currentStadium = 'kÃ¼Ã§Ã¼kmap';
        } else if (['!bÃ¼yÃ¼kmap'].includes(msgArray[0].toLowerCase())) {
            room.setCustomStadium(bigMap);
            room.sendAnnouncement("âœ”ï¸ v3 Futsal á´€á´„ÉªÊŸÉªÊá´Ê€.",null,successColor,"bold",1)
            currentStadium = 'bÃ¼yÃ¼kmap';
        } else if (['!antrenmanmap'].includes(msgArray[0].toLowerCase())) {
            room.setCustomStadium(trainingMap);
            room.sendAnnouncement("âœ”ï¸ Antrenman á´€á´„ÉªÊŸÉªÊá´Ê€.",null,successColor,"bold",1)
            currentStadium = 'antrenmanmap';
        } else {
            room.sendAnnouncement(
                `âš ï¸ Stadyum dosyasÄ± tanÄ±nmadÄ±.`,
                player.id,
                errorColor,
                'bold',
                HaxNotification.CHAT
            );
        }
    } else {
        room.sendAnnouncement(
            `âš ï¸ Bu komutu kullanmadan Ã¶nce oyunu durdurmalÄ±sÄ±n.`,
            player.id,
            errorColor,
            'bold',
            HaxNotification.CHAT
        );
    }
}

function muteCommand(player, message) {
    var msgArray = message.split(/ +/).slice(1);
    if (msgArray.length > 0) {
        if (msgArray[0].length > 0 && msgArray[0][0] == '#') {
            msgArray[0] = msgArray[0].substring(1, msgArray[0].length);
            if (room.getPlayer(parseInt(msgArray[0])) != null) {
                var playerMute = room.getPlayer(parseInt(msgArray[0]));
                var minutesMute = muteDuration;
                if (msgArray.length > 1 && parseInt(msgArray[1]) > 0) {
                    minutesMute = parseInt(msgArray[1]);
                }
                if (!playerMute.admin) {
                    var muteObj = new MutePlayer(playerMute.name, playerMute.id, authArray[playerMute.name][0]);
                    muteObj.setDuration(minutesMute);
                    room.sendAnnouncement(
                        `ğŸ”‡ ${playerMute.name},  ${minutesMute} dakika susturuldu.`,
                        null,
                        announcementColor,
                        'bold',
                        null
                    );
                } else {
                    room.sendAnnouncement(
                        `âš ï¸ Bir admini susturamazsÄ±n.`,
                        player.id,
                        errorColor,
                        'bold',
                        HaxNotification.CHAT
                    );
                }
            } else {
                room.sendAnnouncement(
                    `âš ï¸ Odada bu ID ye sahip bir oyuncu yok.`,
                    player.id,
                    errorColor,
                    'bold',
                    HaxNotification.CHAT
                );
            }
        } else {
            room.sendAnnouncement(
                `âš ï¸ HatalÄ± komut kullanÄ±mÄ±.`,
                player.id,
                errorColor,
                'bold',
                HaxNotification.CHAT
            );
        }
    } else {
        room.sendAnnouncement(
            `âš ï¸ HatalÄ± komut kullanÄ±mÄ±.`,
            player.id,
            errorColor,
            'bold',
            HaxNotification.CHAT
        );
    }
}

function unmuteCommand(player, message) {
    var msgArray = message.split(/ +/).slice(1);
    if (msgArray.length > 0) {
        if (msgArray[0].length > 0 && msgArray[0][0] == '#') {
            msgArray[0] = msgArray[0].substring(1, msgArray[0].length);
            if (room.getPlayer(parseInt(msgArray[0])) != null) {
                var playerUnmute = room.getPlayer(parseInt(msgArray[0]));
                if (muteArray.getByPlayerId(playerUnmute.id) != null) {
                    var muteObj = muteArray.getByPlayerId(playerUnmute.id);
                    muteObj.remove()
                    room.sendAnnouncement(
                        `ğŸ”Š ${playerUnmute.name} isimli oyuncunun susturulma cezasÄ± kaldÄ±rÄ±ldÄ± !`,
                        null,
                        announcementColor,
                        'bold',
                        HaxNotification.CHAT
                    );
                } else {
                    room.sendAnnouncement(
                        `âš ï¸ Bu oyuncu susturulmamÄ±ÅŸ !`,
                        player.id,
                        errorColor,
                        'bold',
                        HaxNotification.CHAT
                    );
                }
            } else {
                room.sendAnnouncement(
                    `âš ï¸ Odada bu ID ye sahip bir oyuncu yok.`,
                    player.id,
                    errorColor,
                    'bold',
                    HaxNotification.CHAT
                );
            }
        } else if (msgArray[0].length > 0 && parseInt(msgArray[0]) > 0 && muteArray.getById(parseInt(msgArray[0])) != null) {
            var playerUnmute = muteArray.getById(parseInt(msgArray[0]));
            playerUnmute.remove();
            room.sendAnnouncement(
                `ğŸ”Š ${playerUnmute.name} isimli oyuncunun susturulma cezasÄ± kaldÄ±rÄ±ldÄ± !`,
                null,
                announcementColor,
                'bold',
                HaxNotification.CHAT
            );
        } else {
            room.sendAnnouncement(
                `âš ï¸ HatalÄ± komut kullanÄ±mÄ±.`,
                player.id,
                errorColor,
                'bold',
                HaxNotification.CHAT
            );
        }
    } else {
        room.sendAnnouncement(
            `âš ï¸ HatalÄ± komut kullanÄ±mÄ±.`,
            player.id,
            errorColor,
            'bold',
            HaxNotification.CHAT
        );
    }
}

function muteListCommand(player, message) {
    if (muteArray.list.length == 0) {
        room.sendAnnouncement(
            "ğŸ”‡ CezalÄ± oyuncu bulunamadÄ±.",
            player.id,
            announcementColor,
            'bold',
            null
        );
        return false;
    }
    var cstm = 'ğŸ”‡ Muteli Oyuncular : ';
    for (let mute of muteArray.list) {
        cstm += mute.name + `[${mute.id}], `;
    }
    cstm = cstm.substring(0, cstm.length - 2) + '.';
    room.sendAnnouncement(
        cstm,
        player.id,
        announcementColor,
        'bold',
        null
    );
}

/* MASTER COMMANDS */

function clearbansCommand(player, message) {
    var msgArray = message.split(/ +/).slice(1);
    if (msgArray.length == 0) {
        room.clearBans();
        room.sendAnnouncement(
            'âœ… Banlar temizlendi.',
            null,
            announcementColor,
            'bold',
            null
        );
        banList = [];
    } else if (msgArray.length == 1) {
        if (parseInt(msgArray[0]) > 0) {
            var ID = parseInt(msgArray[0]);
            room.clearBan(ID);
            if (banList.length != banList.filter((p) => p[1] != ID).length) {
                room.sendAnnouncement(
                    `âœ… ${banList.filter((p) => p[1] == ID)[0][0]} isimli oyuncunun banÄ± kaldÄ±rÄ±ldÄ± !`,
                    null,
                    announcementColor,
                    'bold',
                    null
                );
            } else {
                room.sendAnnouncement(
                    `âš ï¸ Bu ID ile iliÅŸkili bir yasaklama yok.`,
                    player.id,
                    errorColor,
                    'bold',
                    HaxNotification.CHAT
                );
            }
            banList = banList.filter((p) => p[1] != ID);
        } else {
            room.sendAnnouncement(
                `âš ï¸ HatalÄ± ID`,
                player.id,
                errorColor,
                'bold',
                HaxNotification.CHAT
            );
        }
    } else {
        room.sendAnnouncement(
            `âš ï¸ HatalÄ± komut kullanÄ±mÄ±.`,
            player.id,
            errorColor,
            'bold',
            HaxNotification.CHAT
        );
    }
}

function banListCommand(player, message) {
    if (banList.length == 0) {
        room.sendAnnouncement(
            "ğŸ“¢ BanlanmÄ±ÅŸ oyuncu yok.",
            player.id,
            announcementColor,
            'bold',
            null
        );
        return false;
    }
    var cstm = 'ğŸ“¢ BanlÄ± Oyuncular : ';
    for (let ban of banList) {
        cstm += ban[0] + `[${ban[1]}], `;
    }
    cstm = cstm.substring(0, cstm.length - 2) + '.';
    room.sendAnnouncement(
        cstm,
        player.id,
        announcementColor,
        'bold',
        null
    );
}

function adminListCommand(player, message) {
    if (adminList.length == 0) {
        room.sendAnnouncement(
            "ğŸ“¢ ModeratÃ¶r bulunamadÄ± :",
            player.id,
            announcementColor,
            'bold',
            null
        );
        return false;
    }
    var cstm = 'ğŸ“¢ ModeratÃ¶rler : ';
    for (let i = 0; i < adminList.length; i++) {
        cstm += adminList[i][1] + `[${i}], `;
    }
    cstm = cstm.substring(0, cstm.length - 2) + '.';
    room.sendAnnouncement(
        cstm,
        player.id,
        announcementColor,
        'bold',
        null
    );
}

function setAdminCommand(player, message) {
    var msgArray = message.split(/ +/).slice(1);
    if (msgArray.length > 0) {
        if (msgArray[0].length > 0 && msgArray[0][0] == '#') {
            msgArray[0] = msgArray[0].substring(1, msgArray[0].length);
            if (room.getPlayer(parseInt(msgArray[0])) != null) {
                var playerAdmin = room.getPlayer(parseInt(msgArray[0]));

                if (!adminList.map((a) => a[0]).includes(authArray[playerAdmin.name][0])) {
                    if (!masterList.includes(authArray[playerAdmin.name][0])) {
                        room.setPlayerAdmin(playerAdmin.id, true);
                        adminList.push([authArray[playerAdmin.name][0], playerAdmin.name]);
                        room.sendAnnouncement(
                            `ğŸŒ ${playerAdmin.name} isimli oyuncu MODERATOR yetkisi aldÄ± !`,
                            null,
                            announcementColor,
                            'bold',
                            HaxNotification.CHAT
                        );
                    } else {
                        room.sendAnnouncement(
                            `âš ï¸ Bu oyuncunun zaten YÃ–NETÄ°CÄ° yetkisi var !`,
                            player.id,
                            errorColor,
                            'bold',
                            HaxNotification.CHAT
                        );
                    }
                } else {
                    room.sendAnnouncement(
                        `âš ï¸ Bu oyuncu zaten MODERATOR !`,
                        player.id,
                        errorColor,
                        'bold',
                        HaxNotification.CHAT
                    );
                }
            } else {
                room.sendAnnouncement(
                    `âš ï¸ Odada bu ID ye sahip bir oyuncu yok.`,
                    player.id,
                    errorColor,
                    'bold',
                    HaxNotification.CHAT
                );
            }
        } else {
            room.sendAnnouncement(
                `âš ï¸ HatalÄ± komut kullanÄ±mÄ±.`,
                player.id,
                errorColor,
                'bold',
                HaxNotification.CHAT
            );
        }
    } else {
        room.sendAnnouncement(
            `âš ï¸ HatalÄ± komut kullanÄ±mÄ±.`,
            player.id,
            errorColor,
            'bold',
            HaxNotification.CHAT
        );
    }
    
    listeleriGÃ¼ncelle()
}

function removeAdminCommand(player, message) {
    var msgArray = message.split(/ +/).slice(1);
    if (msgArray.length > 0) {
        if (msgArray[0].length > 0 && msgArray[0][0] == '#') {
            msgArray[0] = msgArray[0].substring(1, msgArray[0].length);
            if (room.getPlayer(parseInt(msgArray[0])) != null) {
                var playerAdmin = room.getPlayer(parseInt(msgArray[0]));

                if (adminList.map((a) => a[0]).includes(authArray[playerAdmin.name][0])) {
                    room.setPlayerAdmin(playerAdmin.id, false);
                    adminList = adminList.filter((a) => a[0] != authArray[playerAdmin.name][0]);
                    room.sendAnnouncement(
                        `ğŸŒ ${playerAdmin.name} isimli oyuncunun MODERATOR yetkisi alÄ±ndÄ± !`,
                        null,
                        announcementColor,
                        'bold',
                        HaxNotification.CHAT
                    );
                } else {
                    room.sendAnnouncement(
                        `âš ï¸ Bu oyuncunun MODERATOR yetkisi yok !`,
                        player.id,
                        errorColor,
                        'bold',
                        HaxNotification.CHAT
                    );
                }
            } else {
                room.sendAnnouncement(
                    `âš ï¸ Odada bu ID ye sahip bir oyuncu yok.`,
                    player.id,
                    errorColor,
                    'bold',
                    HaxNotification.CHAT
                );
            }
        } else if (msgArray[0].length > 0 && parseInt(msgArray[0]) < adminList.length) {
            var index = parseInt(msgArray[0]);
            var playerAdmin = adminList[index];
            if (playersAll.findIndex((p) => authArray[p.name][0] == playerAdmin[0]) != -1) {
                // check if there is the removed admin in the room
                var indexRem = playersAll.findIndex((p) => authArray[p.name][0] == playerAdmin[0]);
                room.setPlayerAdmin(playersAll[indexRem].id, false);
            }
            adminList.splice(index,1);
            room.sendAnnouncement(
                `ğŸŒ ${playerAdmin[1]} isimli oyuncunun MODERATOR yetkisi alÄ±ndÄ± !`,
                null,
                announcementColor,
                'bold',
                HaxNotification.CHAT
            );
        } else {
            room.sendAnnouncement(
                `âš ï¸ HatalÄ± komut kullanÄ±mÄ±.`,
                player.id,
                errorColor,
                'bold',
                HaxNotification.CHAT
            );
        }
    } else {
        room.sendAnnouncement(
            `âš ï¸ HatalÄ± komut kullanÄ±mÄ±.`,
            player.id,
            errorColor,
            'bold',
            HaxNotification.CHAT
        );
    }
    listeleriGÃ¼ncelle()
}

function passwordCommand(player, message) {
    var msgArray = message.split(/ +/).slice(1);
    if (msgArray.length > 0) {
        if (msgArray.length == 1 && msgArray[0] == '') {
            roomPassword = '';
            room.setPassword(null);
            room.sendAnnouncement(
                `ğŸ”‘ Oda ÅŸifresi kaldÄ±rÄ±ldÄ±.`,
                player.id,
                announcementColor,
                'bold',
                HaxNotification.CHAT
            );
        }
        roomPassword = msgArray.join(' ');
        room.setPassword(roomPassword);
        room.sendAnnouncement(
            `ğŸ”‘ Odaya ÅŸifre konuldu: ${roomPassword}`,
            player.id,
            announcementColor,
            'bold',
            HaxNotification.CHAT
        );
    } else {
        if (roomPassword != '') {
            roomPassword = '';
            room.setPassword(null);
            room.sendAnnouncement(
                `ğŸ”‘ Oda ÅŸifresi kaldÄ±rÄ±ldÄ±.`,
                player.id,
                announcementColor,
                'bold',
                HaxNotification.CHAT
            );
        } else {
            room.sendAnnouncement(
                `âš ï¸ OdanÄ±n ÅŸuan bir ÅŸifresi yok.`,
                player.id,
                errorColor,
                'bold',
                HaxNotification.CHAT
            );
        }
    }
}

/* GAME FUNCTIONS */

function checkTime() {
    const scores = room.getScores();
    if (game != undefined) game.scores = scores;
    if (Math.abs(scores.time - scores.timeLimit) <= 0.01 && scores.timeLimit != 0 && playSituation == Situation.PLAY) {
        if (scores.red != scores.blue) {
            if (!checkTimeVariable) {
                checkTimeVariable = true;
                setTimeout(() => {
                    checkTimeVariable = false;
                }, 3000);
                scores.red > scores.blue ? endGame(Team.RED) : endGame(Team.BLUE);
                stopTimeout = setTimeout(() => {
                    room.stopGame();
                }, 2000);
            }
            return;
        }
        if (drawTimeLimit != 0) {
            goldenGoal = true;
            room.sendAnnouncement(
                'ğŸ“¢ Skorlar eÅŸit. Ä°lk golÃ¼ atan kazanacak!',
                null,
                announcementColor,
                'bold',
                HaxNotification.CHAT
            );
        }
    }
    if (Math.abs(scores.time - drawTimeLimit * 60 - scores.timeLimit) <= 0.01 && scores.timeLimit != 0) {
        if (!checkTimeVariable) {
            checkTimeVariable = true;
            setTimeout(() => {
                checkTimeVariable = false;
            }, 10);
            endGame(Team.SPECTATORS);
            room.stopGame();
            goldenGoal = false;
        }
    }
}

function instantRestart() {
    room.stopGame();
    startTimeout = setTimeout(() => {
        room.startGame();
    }, 10);
}

function resumeGame() {
    startTimeout = setTimeout(() => {
        room.startGame();
    }, 1000);
    setTimeout(() => {
        room.pauseGame(false);
    }, 500);
}

function endGame(winner) {
    if (players.length >= 2 * teamSize - 1) activateChooseMode();
    const scores = room.getScores();
    game.scores = scores;
    lastWinner = winner;
    endGameVariable = true;
    let possessionRedPct = (possession[0] / (possession[0] + possession[1])) * 100;
    let possessionBluePct = 100 - possessionRedPct;
    let possessionString = `ğŸ”´ ${possessionRedPct.toFixed(0)}% âš”ï¸ ${possessionBluePct.toFixed(0)}% ğŸ”µ`;
    let actionRedPct = (actionZoneHalf[0] / (actionZoneHalf[0] + actionZoneHalf[1])) * 100;
    let actionBluePct = 100 - actionRedPct;
    let actionString = `ğŸ”´ ${actionRedPct.toFixed(0)}% âš”ï¸ ${actionBluePct.toFixed(0)}% ğŸ”µ`;

    var totalPasses = Math.floor(Math.random() * 11) + 25;
    var possR = possession[0] / (possession[0] + possession[1]); 
    var passesRed = Math.round(totalPasses * possR); 
    var passesBlue = totalPasses - passesRed;
    let passString = `ğŸ”´ ${passesRed} âš”ï¸ ${passesBlue} ğŸ”µ`;

    let CSString = getCSString(scores);
    room.sendAnnouncement(
        `â–ˆğŸ“Š á´›á´á´˜á´€ sá´€ÊœÉªá´˜ á´ÊŸá´á´€ ${possessionString}\n` +
        `â–ˆğŸ“ˆ Éªêœ±Éª Êœá´€Ê€Éªá´›á´€êœ±Éª  ${actionString}\n` +
        `â–ˆğŸ“‰ á´˜á´€êœ± Êœá´€Ê€Éªá´›á´€êœ±Éª  ${passString}\n` +
        `${CSString}`,
        null,
        0xff8901,
        'bold',
        HaxNotification.NONE
    );
    if (winner == Team.RED) {
        streak++;
        room.sendAnnouncement(
            `ğŸ”´ ğ¾ğ¼ğ‘…ğ‘€ğ¼ğ‘ğ¼ ${streak} á´á´€á´„á´›ÉªÊ€ á´‹á´€á´¢á´€É´ÉªÊá´Ê€.`,
            null,
            0xb1bff9,
            'bold',
            HaxNotification.CHAT
        );
    } else if (winner == Team.BLUE) {
        streak = 1;
        room.sendAnnouncement(
            `ğŸ”µ ğ‘€ğ´ğ‘‰ğ¼Ì‡ ${streak} á´á´€á´„á´›ÉªÊ€ á´‹á´€á´¢á´€É´ÉªÊá´Ê€.`,
            null,
            0xb1bff9,
            'bold',
            HaxNotification.CHAT
        );
    } else {
        streak = 0;
        room.sendAnnouncement(
            'ğŸ’¤ ğ‘€ğ‘ğ‘ ğµğ‘’ğ‘Ÿğ‘ğ‘ğ‘’ğ‘Ÿğ‘’ ğµğ‘–ğ‘¡ğ‘¡ğ‘–',
            null,
            0xb1bff9,
            'bold',
            HaxNotification.CHAT
        );
    }
    updateStats();
}

/* CHOOSING FUNCTIONS */

function activateChooseMode() {
    chooseMode = true;
    slowMode = chooseModeSlowMode;
    room.sendAnnouncement(
        `ğŸ“¢ Eksik oyuncular var. LÃ¼tfen oyuncu seÃ§in.`,
        null,
        announcementColor,
        'bold',
        HaxNotification.CHAT
    );
}

function deactivateChooseMode() {
    chooseMode = false;
    clearTimeout(timeOutCap);
    if (slowMode != defaultSlowMode) {
        slowMode = defaultSlowMode;
    }
    redCaptainChoice = '';
    blueCaptainChoice = '';
}

function getSpecList(player) {
    if (player == null) return null;
    var cstm = 'Oyuncular : ';
    for (let i = 0; i < teamSpec.length; i++) {
        cstm += teamSpec[i].name + `[${i + 1}], `;
    }
    cstm = cstm.substring(0, cstm.length - 2) + '.';
    room.sendAnnouncement(
        cstm,
        player.id,
        infoColor,
        'bold',
        HaxNotification.CHAT
    );
}

function choosePlayer() {
    clearTimeout(timeOutCap);
    let captain;
    if (teamRed.length <= teamBlue.length && teamRed.length != 0) {
        captain = teamRed[0];
    } else if (teamBlue.length < teamRed.length && teamBlue.length != 0) {
        captain = teamBlue[0];
    }
    if (captain != null) {
        room.sendAnnouncement(
            "ğŸ“¢ Bir oyuncu seÃ§mek iÃ§in oyuncunun listede verilen numarasÄ±nÄ± gir yada 'random' yazarak rastgele seÃ§.",
            captain.id,
            infoColor,
            'bold',
            HaxNotification.MENTION
        );
        timeOutCap = setTimeout(
            (player) => {
                room.sendAnnouncement(
                    `â›” Acele et ${player.name}, oyuncu seÃ§mek iÃ§in sadece ${Number.parseInt(String(chooseTime / 2))} saniyen kalÄ±d !`,
                    player.id,
                    warningColor,
                    'bold',
                    HaxNotification.MENTION
                );
                timeOutCap = setTimeout(
                    (player) => {
                        room.kickPlayer(
                            player.id,
                            "Oyuncu seÃ§mediÄŸin iÃ§in atÄ±ldÄ±n !",
                            false
                        );
                    },
                    chooseTime * 500,
                    captain
                );
            },
            chooseTime * 1000,
            captain
        );
    }
    if (teamRed.length != 0 && teamBlue.length != 0) {
        getSpecList(teamRed.length <= teamBlue.length ? teamRed[0] : teamBlue[0]);
    }
}

function chooseModeFunction(player, message) {
    var msgArray = message.split(/ +/);
    if (player.id == teamRed[0].id || player.id == teamBlue[0].id) {
        if (teamRed.length <= teamBlue.length && player.id == teamRed[0].id) {
            if (['top', 'auto'].includes(msgArray[0].toLowerCase())) {
                room.setPlayerTeam(teamSpec[0].id, Team.RED);
                redCaptainChoice = 'top';
                clearTimeout(timeOutCap);
                room.sendAnnouncement(
                    `${player.name} oyuncu seÃ§ti !`,
                    null,
                    announcementColor,
                    'bold',
                    HaxNotification.CHAT
                );
            } else if (['random', 'rand'].includes(msgArray[0].toLowerCase())) {
                var r = getRandomInt(teamSpec.length);
                room.setPlayerTeam(teamSpec[r].id, Team.RED);
                redCaptainChoice = 'random';
                clearTimeout(timeOutCap);
                room.sendAnnouncement(
                    `ğŸ“¢ ${player.name} isimli oyuncu rastgele oyuncu seÃ§ti !`,
                    null,
                    announcementColor,
                    'bold',
                    HaxNotification.CHAT
                );
            } else if (['bottom', 'bot'].includes(msgArray[0].toLowerCase())) {
                room.setPlayerTeam(teamSpec[teamSpec.length - 1].id, Team.RED);
                redCaptainChoice = 'bottom';
                clearTimeout(timeOutCap);
                room.sendAnnouncement(
                    `${player.name} oyuncu seÃ§ti !`,
                    null,
                    announcementColor,
                    'bold',
                    HaxNotification.CHAT
                );
            } else if (!Number.isNaN(Number.parseInt(msgArray[0]))) {
                if (Number.parseInt(msgArray[0]) > teamSpec.length || Number.parseInt(msgArray[0]) < 1) {
                    room.sendAnnouncement(
                        `âš ï¸ HatalÄ± numara !`,
                        player.id,
                        errorColor,
                        'bold',
                        HaxNotification.CHAT
                    );
                } else {
                    room.setPlayerTeam(
                        teamSpec[Number.parseInt(msgArray[0]) - 1].id,
                        Team.RED
                    );
                    room.sendAnnouncement(
                        `ğŸ“¢ ${player.name}, ${teamSpec[Number.parseInt(msgArray[0]) - 1].name} isimli oyuncuyu seÃ§ti !`,
                        null,
                        announcementColor,
                        'bold',
                        HaxNotification.CHAT
                    );
                }
            } else return false;
            return true;
        }
        if (teamRed.length > teamBlue.length && player.id == teamBlue[0].id) {
            if (['top', 'auto'].includes(msgArray[0].toLowerCase())) {
                room.setPlayerTeam(teamSpec[0].id, Team.BLUE);
                blueCaptainChoice = 'top';
                clearTimeout(timeOutCap);
                room.sendAnnouncement(
                    `${player.name} oyuncu seÃ§ti !`,
                    null,
                    announcementColor,
                    'bold',
                    HaxNotification.CHAT
                );
            } else if (['random', 'rand'].includes(msgArray[0].toLowerCase())) {
                room.setPlayerTeam(
                    teamSpec[getRandomInt(teamSpec.length)].id,
                    Team.BLUE
                );
                blueCaptainChoice = 'random';
                clearTimeout(timeOutCap);
                room.sendAnnouncement(
                    `ğŸ“¢ ${player.name} isimli oyuncu rastgele oyuncu seÃ§ti !`,
                    null,
                    announcementColor,
                    'bold',
                    HaxNotification.CHAT
                );
            } else if (['bottom', 'bot'].includes(msgArray[0].toLowerCase())) {
                room.setPlayerTeam(teamSpec[teamSpec.length - 1].id, Team.BLUE);
                blueCaptainChoice = 'bottom';
                clearTimeout(timeOutCap);
                room.sendAnnouncement(
                    `${player.name} oyuncu seÃ§ti !`,
                    null,
                    announcementColor,
                    'bold',
                    HaxNotification.CHAT
                );
            } else if (!Number.isNaN(Number.parseInt(msgArray[0]))) {
                if (Number.parseInt(msgArray[0]) > teamSpec.length || Number.parseInt(msgArray[0]) < 1) {
                    room.sendAnnouncement(
                        `âš ï¸ HatalÄ± numara !`,
                        player.id,
                        errorColor,
                        'bold',
                        HaxNotification.CHAT
                    );
                } else {
                    room.setPlayerTeam(
                        teamSpec[Number.parseInt(msgArray[0]) - 1].id,
                        Team.BLUE
                    );
                    room.sendAnnouncement(
                        `ğŸ“¢ ${player.name}, ${teamSpec[Number.parseInt(msgArray[0]) - 1].name} isimli oyuncuyu seÃ§ti !`,
                        null,
                        announcementColor,
                        'bold',
                        HaxNotification.CHAT
                    );
                }
            } else return false;
            return true;
        }
    }
}

function checkCaptainLeave(player) {
    if (
        (teamRed.findIndex((red) => red.id == player.id) == 0 && chooseMode && teamRed.length <= teamBlue.length) ||
        (teamBlue.findIndex((blue) => blue.id == player.id) == 0 && chooseMode && teamBlue.length < teamRed.length)
    ) {
        choosePlayer();
        capLeft = true;
        setTimeout(() => {
            capLeft = false;
        }, 10);
    }
}

function slowModeFunction(player, message) {
    if (!player.admin) {
        if (!SMSet.has(player.id)) {
            SMSet.add(player.id);
            setTimeout(
                (number) => {
                    SMSet.delete(number);
                },
                slowMode * 1000,
                player.id
            );
        } else {
            return true;
        }
    }
    return false;
}

/* PLAYER FUNCTIONS */

function updateTeams() {
    playersAll = room.getPlayerList();
    players = playersAll.filter((p) => !AFKSet.has(p.id));
    teamRed = players.filter((p) => p.team == Team.RED);
    teamBlue = players.filter((p) => p.team == Team.BLUE);
    teamSpec = players.filter((p) => p.team == Team.SPECTATORS);
}

function updateAdmins(excludedPlayerID = 0) {
    if (players.length != 0 && players.filter((p) => p.admin).length < maxAdmins) {
        let playerArray = players.filter((p) => p.id != excludedPlayerID && !p.admin);
        let arrayID = playerArray.map((player) => player.id);
        room.setPlayerAdmin(Math.min(...arrayID), true);
    }
}

function getRole(player) {
    return (
        !!masterList.find((a) => a == authArray[player.name][0]) * 2 +
        !!adminList.find((a) => a[0] == authArray[player.name][0]) * 1 +
        player.admin * 1
    );
}

function ghostKickHandle(oldP, newP) {
    var teamArrayId = getTeamArray(oldP.team, true).map((p) => p.id);
    teamArrayId.splice(teamArrayId.findIndex((id) => id == oldP.id), 1, newP.id);

    room.kickPlayer(oldP.id, 'AynÄ± IP Ã¼zerinden giriÅŸ tespit edildi. Oyuncu uzaklaÅŸtÄ±rÄ±ldÄ±.', true);
    room.setPlayerTeam(newP.id, oldP.team);
    room.setPlayerAdmin(newP.id, oldP.admin);
    room.reorderPlayers(teamArrayId, true);

    if (oldP.team != Team.SPECTATORS && playSituation != Situation.STOP) {
        var discProp = room.getPlayerDiscProperties(oldP.id);
        room.setPlayerDiscProperties(newP.id, discProp);
    }
}

/* ACTIVITY FUNCTIONS */

function handleActivityPlayer(player) {
    let pComp = getPlayerComp(player);
    if (pComp != null) {
        pComp.inactivityTicks++;
        if (pComp.inactivityTicks == 60 * ((2 / 3) * afkLimit)) {
            room.sendAnnouncement(
                `ğŸ“£ @${player.name}, Êœá´€Ê€á´‡á´‹á´‡á´› á´‡á´›á´á´‡á´¢sá´‡É´ á´ á´‡Êá´€ á´á´‡sá´€á´Š Êá´€á´¢á´á´€á´¢sá´€É´ ${Math.floor(afkLimit / 3)} sá´€É´ÉªÊá´‡ Éªá´„ÉªÉ´á´…á´‡, á´á´…á´€á´…á´€É´ á´€á´›ÉªÊŸá´€á´„á´€á´‹sÉªÉ´.`,
                player.id,
                null,
                'normal',
                HaxNotification.MENTION
            );
            return;
        }
        if (pComp.inactivityTicks >= 60 * afkLimit) {
            pComp.inactivityTicks = 0;
            if (game.scores.time <= afkLimit - 0.5) {
                setTimeout(() => {
                    !chooseMode ? instantRestart() : room.stopGame();
                }, 10);
            }
            room.kickPlayer(player.id, 'AFK', false);
        }
    }
}

function handleActivityPlayerTeamChange(changedPlayer) {
    if (changedPlayer.team == Team.SPECTATORS) {
        let pComp = getPlayerComp(changedPlayer);
        if (pComp != null) pComp.inactivityTicks = 0;
    }
}

function handleActivityStop() {
    for (let player of players) {
        let pComp = getPlayerComp(player);
        if (pComp != null) pComp.inactivityTicks = 0;
    }
}

function handleActivity() {
    if (gameState === State.PLAY && players.length > 1) {
        for (let player of teamRed) {
            handleActivityPlayer(player);
        }
        for (let player of teamBlue) {
            handleActivityPlayer(player);
        }
    }
}

/* LINEUP FUNCTIONS */

function getStartingLineups() {
    var compositions = [[], []];
    for (let player of teamRed) {
        compositions[0].push(
            new PlayerComposition(player, authArray[player.name][0], [0], [])
        );
    }
    for (let player of teamBlue) {
        compositions[1].push(
            new PlayerComposition(player, authArray[player.name][0], [0], [])
        );
    }
    return compositions;
}

function handleLineupChangeTeamChange(changedPlayer) {
    if (gameState != State.STOP) {
        var playerLineup;
        if (changedPlayer.team == Team.RED) {
            // player gets in red team
            var redLineupAuth = game.playerComp[0].map((p) => p.auth);
            var ind = redLineupAuth.findIndex((auth) => auth == authArray[changedPlayer.name][0]);
            if (ind != -1) {
                // Player goes back in
                playerLineup = game.playerComp[0][ind];
                if (playerLineup.timeExit.includes(game.scores.time)) {
                    // gets subbed off then in at the exact same time -> no sub
                    playerLineup.timeExit = playerLineup.timeExit.filter((t) => t != game.scores.time);
                } else {
                    playerLineup.timeEntry.push(game.scores.time);
                }
            } else {
                playerLineup = new PlayerComposition(
                    changedPlayer,
                    authArray[changedPlayer.name][0],
                    [game.scores.time],
                    []
                );
                game.playerComp[0].push(playerLineup);
            }
        } else if (changedPlayer.team == Team.BLUE) {
            // player gets in blue team
            var blueLineupAuth = game.playerComp[1].map((p) => p.auth);
            var ind = blueLineupAuth.findIndex((auth) => auth == authArray[changedPlayer.name][0]);
            if (ind != -1) {
                // Player goes back in
                playerLineup = game.playerComp[1][ind];
                if (playerLineup.timeExit.includes(game.scores.time)) {
                    // gets subbed off then in at the exact same time -> no sub
                    playerLineup.timeExit = playerLineup.timeExit.filter((t) => t != game.scores.time);
                } else {
                    playerLineup.timeEntry.push(game.scores.time);
                }
            } else {
                playerLineup = new PlayerComposition(
                    changedPlayer,
                    authArray[changedPlayer.name][0],
                    [game.scores.time],
                    []
                );
                game.playerComp[1].push(playerLineup);
            }
        }
        if (teamRed.some((r) => r.id == changedPlayer.id)) {
            // player leaves red team
            var redLineupAuth = game.playerComp[0].map((p) => p.auth);
            var ind = redLineupAuth.findIndex((auth) => auth == authArray[changedPlayer.name][0]);
            playerLineup = game.playerComp[0][ind];
            if (playerLineup.timeEntry.includes(game.scores.time)) {
                // gets subbed off then in at the exact same time -> no sub
                if (game.scores.time == 0) {
                    game.playerComp[0].splice(ind, 1);
                } else {
                    playerLineup.timeEntry = playerLineup.timeEntry.filter((t) => t != game.scores.time);
                }
            } else {
                playerLineup.timeExit.push(game.scores.time);
            }
        } else if (teamBlue.some((r) => r.id == changedPlayer.id)) {
            // player leaves blue team
            var blueLineupAuth = game.playerComp[1].map((p) => p.auth);
            var ind = blueLineupAuth.findIndex((auth) => auth == authArray[changedPlayer.name][0]);
            playerLineup = game.playerComp[1][ind];
            if (playerLineup.timeEntry.includes(game.scores.time)) {
                // gets subbed off then in at the exact same time -> no sub
                if (game.scores.time == 0) {
                    game.playerComp[1].splice(ind, 1);
                } else {
                    playerLineup.timeEntry = playerLineup.timeEntry.filter((t) => t != game.scores.time);
                }
            } else {
                playerLineup.timeExit.push(game.scores.time);
            }
        }
    }
}

function handleLineupChangeLeave(player) {
    if (playSituation != Situation.STOP) {
        if (player.team == Team.RED) {
            // player gets in red team
            var redLineupAuth = game.playerComp[0].map((p) => p.auth);
            var ind = redLineupAuth.findIndex((auth) => auth == authArray[player.name][0]);
            var playerLineup = game.playerComp[0][ind];
            if (playerLineup.timeEntry.includes(game.scores.time)) {
                // gets subbed off then in at the exact same time -> no sub
                if (game.scores.time == 0) {
                    game.playerComp[0].splice(ind, 1);
                } else {
                    playerLineup.timeEntry = playerLineup.timeEntry.filter((t) => t != game.scores.time);
                }
            } else {
                playerLineup.timeExit.push(game.scores.time);
            }
        } else if (player.team == Team.BLUE) {
            // player gets in blue team
            var blueLineupAuth = game.playerComp[1].map((p) => p.auth);
            var ind = blueLineupAuth.findIndex((auth) => auth == authArray[player.name][0]);
            var playerLineup = game.playerComp[1][ind];
            if (playerLineup.timeEntry.includes(game.scores.time)) {
                // gets subbed off then in at the exact same time -> no sub
                if (game.scores.time == 0) {
                    game.playerComp[1].splice(ind, 1);
                } else {
                    playerLineup.timeEntry = playerLineup.timeEntry.filter((t) => t != game.scores.time);
                }
            } else {
                playerLineup.timeExit.push(game.scores.time);
            }
        }
    }
}

/* TEAM BALANCE FUNCTIONS */

function balanceTeams() {
    if (!chooseMode) {
        if (players.length == 0) {
            room.stopGame();
            room.setScoreLimit(scoreLimit);
            room.setTimeLimit(timeLimit);
        } else if (players.length == 1 && teamRed.length == 0) {
            instantRestart();
            setTimeout(() => {
                stadiumCommand(emptyPlayer, `!antrenmanmap`);
            }, 5);
            room.setPlayerTeam(players[0].id, Team.RED);
        } else if (Math.abs(teamRed.length - teamBlue.length) == teamSpec.length && teamSpec.length > 0) {
            const n = Math.abs(teamRed.length - teamBlue.length);
            if (players.length == 2) {
                instantRestart();
                setTimeout(() => {
                    stadiumCommand(emptyPlayer, `!kÃ¼Ã§Ã¼kmap`);
                }, 5);
            }
            if (teamRed.length > teamBlue.length) {
                for (var i = 0; i < n; i++) {
                    room.setPlayerTeam(teamSpec[i].id, Team.BLUE);
                }
            } else {
                for (var i = 0; i < n; i++) {
                    room.setPlayerTeam(teamSpec[i].id, Team.RED);
                }
            }
        } else if (Math.abs(teamRed.length - teamBlue.length) > teamSpec.length) {
            const n = Math.abs(teamRed.length - teamBlue.length);
            if (players.length == 1) {
                instantRestart();
                setTimeout(() => {
                    stadiumCommand(emptyPlayer, `!antrenmanmap`);
                }, 5);
                room.setPlayerTeam(players[0].id, Team.RED);
                return;
            } else if (teamSize > 2 && players.length == 5) {
                instantRestart();
                setTimeout(() => {
                    stadiumCommand(emptyPlayer, `!kÃ¼Ã§Ã¼kmap`);
                }, 5);
            }
            if (players.length == teamSize * 2 - 1) {
                teamRedStats = [];
                teamBlueStats = [];
            }
            if (teamRed.length > teamBlue.length) {
                for (var i = 0; i < n; i++) {
                    room.setPlayerTeam(
                        teamRed[teamRed.length - 1 - i].id,
                        Team.SPECTATORS
                    );
                }
            } else {
                for (var i = 0; i < n; i++) {
                    room.setPlayerTeam(
                        teamBlue[teamBlue.length - 1 - i].id,
                        Team.SPECTATORS
                    );
                }
            }
        } else if (Math.abs(teamRed.length - teamBlue.length) < teamSpec.length && teamRed.length != teamBlue.length) {
            room.pauseGame(true);
            activateChooseMode();
            choosePlayer();
        } else if (teamSpec.length >= 2 && teamRed.length == teamBlue.length && teamRed.length < teamSize) {
            if (teamRed.length == 2) {
                instantRestart();
                setTimeout(() => {
                    stadiumCommand(emptyPlayer, `!bÃ¼yÃ¼kmap`);
                }, 5);
            }
            topButton();
        }
    }
}

function handlePlayersJoin() {
    if (chooseMode) {
        if (teamSize > 2 && players.length == 6) {
            setTimeout(() => {
                stadiumCommand(emptyPlayer, `!bÃ¼yÃ¼kmap`);
            }, 5);
        }
        getSpecList(teamRed.length <= teamBlue.length ? teamRed[0] : teamBlue[0]);
    }
    balanceTeams();
}

function handlePlayersLeave() {
    if (gameState != State.STOP) {
        var scores = room.getScores();
        if (players.length >= 2 * teamSize && scores.time >= (5 / 6) * game.scores.timeLimit && teamRed.length != teamBlue.length) {
            var rageQuitCheck = false;
            if (teamRed.length < teamBlue.length) {
                if (scores.blue - scores.red == 2) {
                    endGame(Team.BLUE);
                    rageQuitCheck = true;
                }
            } else {
                if (scores.red - scores.blue == 2) {
                    endGame(Team.RED);
                    rageQuitCheck = true;
                }
            }
            if (rageQuitCheck) {
                room.sendAnnouncement(
                    "ğŸ“¢ Bir oyuncu oyundan kaÃ§tÄ±. Oyuncu cezalandÄ±rÄ±ldÄ±.",
                    null,
                    infoColor,
                    'bold',
                    HaxNotification.MENTION
                )
                stopTimeout = setTimeout(() => {
                    room.stopGame();
                }, 100);
                return;
            }
        }
    }
    if (chooseMode) {
        if (teamSize > 2 && players.length == 5) {
            setTimeout(() => {
                stadiumCommand(emptyPlayer, `!kÃ¼Ã§Ã¼kmap`);
            }, 5);
        }
        if (teamRed.length == 0 || teamBlue.length == 0) {
            room.setPlayerTeam(teamSpec[0].id, teamRed.length == 0 ? Team.RED : Team.BLUE);
            return;
        }
        if (Math.abs(teamRed.length - teamBlue.length) == teamSpec.length) {
            deactivateChooseMode();
            resumeGame();
            var b = teamSpec.length;
            if (teamRed.length > teamBlue.length) {
                for (var i = 0; i < b; i++) {
                    clearTimeout(insertingTimeout);
                    insertingPlayers = true;
                    setTimeout(() => {
                        room.setPlayerTeam(teamSpec[0].id, Team.BLUE);
                    }, 5 * i);
                }
                insertingTimeout = setTimeout(() => {
                    insertingPlayers = false;
                }, 5 * b);
            } else {
                for (var i = 0; i < b; i++) {
                    clearTimeout(insertingTimeout);
                    insertingPlayers = true;
                    setTimeout(() => {
                        room.setPlayerTeam(teamSpec[0].id, Team.RED);
                    }, 5 * i);
                }
                insertingTimeout = setTimeout(() => {
                    insertingPlayers = false;
                }, 5 * b);
            }
            return;
        }
        if (streak == 0 && gameState == State.STOP) {
            if (Math.abs(teamRed.length - teamBlue.length) == 2) {
                var teamIn = teamRed.length > teamBlue.length ? teamRed : teamBlue;
                room.setPlayerTeam(teamIn[teamIn.length - 1].id, Team.SPECTATORS)
            }
        }
        if (teamRed.length == teamBlue.length && teamSpec.length < 2) {
            deactivateChooseMode();
            resumeGame();
            return;
        }

        if (capLeft) {
            choosePlayer();
        } else {
            getSpecList(teamRed.length <= teamBlue.length ? teamRed[0] : teamBlue[0]);
        }
    }
    balanceTeams();
}

function handlePlayersTeamChange(byPlayer) {
    if (chooseMode && !removingPlayers && byPlayer == null) {
        if (Math.abs(teamRed.length - teamBlue.length) == teamSpec.length) {
            deactivateChooseMode();
            resumeGame();
            var b = teamSpec.length;
            if (teamRed.length > teamBlue.length) {
                for (var i = 0; i < b; i++) {
                    clearTimeout(insertingTimeout);
                    insertingPlayers = true;
                    setTimeout(() => {
                        room.setPlayerTeam(teamSpec[0].id, Team.BLUE);
                    }, 5 * i);
                }
                insertingTimeout = setTimeout(() => {
                    insertingPlayers = false;
                }, 5 * b);
            } else {
                for (var i = 0; i < b; i++) {
                    clearTimeout(insertingTimeout);
                    insertingPlayers = true;
                    setTimeout(() => {
                        room.setPlayerTeam(teamSpec[0].id, Team.RED);
                    }, 5 * i);
                }
                insertingTimeout = setTimeout(() => {
                    insertingPlayers = false;
                }, 5 * b);
            }
            return;
        } else if (
            (teamRed.length == teamSize && teamBlue.length == teamSize) ||
            (teamRed.length == teamBlue.length && teamSpec.length < 2)
        ) {
            deactivateChooseMode();
            resumeGame();
        } else if (teamRed.length <= teamBlue.length && redCaptainChoice != '') {
            if (redCaptainChoice == 'top') {
                room.setPlayerTeam(teamSpec[0].id, Team.RED);
            } else if (redCaptainChoice == 'random') {
                var r = getRandomInt(teamSpec.length);
                room.setPlayerTeam(teamSpec[r].id, Team.RED);
            } else {
                room.setPlayerTeam(teamSpec[teamSpec.length - 1].id, Team.RED);
            }
            return;
        } else if (teamBlue.length < teamRed.length && blueCaptainChoice != '') {
            if (blueCaptainChoice == 'top') {
                room.setPlayerTeam(teamSpec[0].id, Team.BLUE);
            } else if (blueCaptainChoice == 'random') {
                var r = getRandomInt(teamSpec.length);
                room.setPlayerTeam(teamSpec[r].id, Team.BLUE);
            } else {
                room.setPlayerTeam(teamSpec[teamSpec.length - 1].id, Team.BLUE);
            }
            return;
        } else {
            choosePlayer();
        }
    }
}

function handlePlayersStop(byPlayer) {
    if (byPlayer == null && endGameVariable) {
        if (chooseMode) {
            if (players.length == 2 * teamSize) {
                chooseMode = false;
                resetButton();
                for (var i = 0; i < teamSize; i++) {
                    clearTimeout(insertingTimeout);
                    insertingPlayers = true;
                    setTimeout(() => {
                        randomButton();
                    }, 200 * i);
                }
                insertingTimeout = setTimeout(() => {
                    insertingPlayers = false;
                }, 200 * teamSize);
                startTimeout = setTimeout(() => {
                    room.startGame();
                }, 2000);
            } else {
                if (lastWinner == Team.RED) {
                    blueToSpecButton();
                } else if (lastWinner == Team.BLUE) {
                    redToSpecButton();
                    setTimeout(() => {
                        swapButton();
                    }, 10);
                } else {
                    resetButton();
                }
                clearTimeout(insertingTimeout);
                insertingPlayers = true;
                setTimeout(() => {
                    topButton();
                }, 300);
                insertingTimeout = setTimeout(() => {
                    insertingPlayers = false;
                }, 300);
            }
        } else {
            if (players.length == 2) {
                if (lastWinner == Team.BLUE) {
                    swapButton();
                }
                startTimeout = setTimeout(() => {
                    room.startGame();
                }, 2000);
            } else if (players.length == 3 || players.length >= 2 * teamSize + 1) {
                if (lastWinner == Team.RED) {
                    blueToSpecButton();
                } else {
                    redToSpecButton();
                    setTimeout(() => {
                        swapButton();
                    }, 5);
                }
                clearTimeout(insertingTimeout);
                insertingPlayers = true;
                setTimeout(() => {
                    topButton();
                }, 200);
                insertingTimeout = setTimeout(() => {
                    insertingPlayers = false;
                }, 300);
                startTimeout = setTimeout(() => {
                    room.startGame();
                }, 2000);
            } else if (players.length == 4) {
                resetButton();
                clearTimeout(insertingTimeout);
                insertingPlayers = true;
                setTimeout(() => {
                    randomButton();
                    setTimeout(() => {
                        randomButton();
                    }, 500);
                }, 500);
                insertingTimeout = setTimeout(() => {
                    insertingPlayers = false;
                }, 2000);
                startTimeout = setTimeout(() => {
                    room.startGame();
                }, 2000);
            } else if (players.length == 5 || players.length >= 2 * teamSize + 1) {
                if (lastWinner == Team.RED) {
                    blueToSpecButton();
                } else {
                    redToSpecButton();
                    setTimeout(() => {
                        swapButton();
                    }, 5);
                }
                clearTimeout(insertingTimeout);
                insertingPlayers = true;
                insertingTimeout = setTimeout(() => {
                    insertingPlayers = false;
                }, 200);
                setTimeout(() => {
                    topButton();
                }, 200);
                activateChooseMode();
            } else if (players.length == 6) {
                resetButton();
                clearTimeout(insertingTimeout);
                insertingPlayers = true;
                insertingTimeout = setTimeout(() => {
                    insertingPlayers = false;
                }, 1500);
                setTimeout(() => {
                    randomButton();
                    setTimeout(() => {
                        randomButton();
                        setTimeout(() => {
                            randomButton();
                        }, 500);
                    }, 500);
                }, 500);
                startTimeout = setTimeout(() => {
                    room.startGame();
                }, 2000);
            }
        }
    }
}

/* STATS FUNCTIONS */

/* GK FUNCTIONS */

function handleGKTeam(team) {
    if (team == Team.SPECTATORS) {
        return null;
    }
    let teamArray = team == Team.RED ? teamRed : teamBlue;
    let playerGK = teamArray.reduce((prev, current) => {
        if (team == Team.RED) {
            return (prev?.position.x < current.position.x) ? prev : current
        } else {
            return (prev?.position.x > current.position.x) ? prev : current
        }
    }, null);
    let playerCompGK = getPlayerComp(playerGK);
    return playerCompGK;
}

function handleGK() {
    let redGK = handleGKTeam(Team.RED);
    if (redGK != null) {
        redGK.GKTicks++;
    }
    let blueGK = handleGKTeam(Team.BLUE);
    if (blueGK != null) {
        blueGK.GKTicks++;
    }
}

function getGK(team) {
    if (team == Team.SPECTATORS) {
        return null;
    }
    let teamArray = team == Team.RED ? game.playerComp[0] : game.playerComp[1];
    let playerGK = teamArray.reduce((prev, current) => {
        return (prev?.GKTicks > current.GKTicks) ? prev : current
    }, null);
    return playerGK;
}

function getCS(scores) {
    let playersNameCS = [];
    let redGK = getGK(Team.RED);
    let blueGK = getGK(Team.BLUE);
    if (redGK != null && scores.blue == 0) {
        playersNameCS.push(redGK.player.name);
    }
    if (blueGK != null && scores.red == 0) {
        playersNameCS.push(blueGK.player.name);
    }
    return playersNameCS;
}

function getCSString(scores) {
    let playersCS = getCS(scores);
    if (playersCS.length == 0) {
        return "ğŸ¥… MaÃ§Ä± gol yemeden tamamlayan kaleci yok !";
    } else if (playersCS.length == 1) {
        return `ğŸ¥… ${playersCS[0]} maÃ§Ä± gol yemeden tamamladÄ± !`;
    } else {
        return `ğŸ¥… ${playersCS[0]} ve ${playersCS[1]} maÃ§Ä± gol yemeden tamamladÄ± !`;
    }
}

/* GLOBAL STATS FUNCTIONS */

function getLastTouchOfTheBall() {
    const ballPosition = room.getBallPosition();
    updateTeams();
    let playerArray = [];
    for (let player of players) {
        if (player.position != null) {
            var distanceToBall = pointDistance(player.position, ballPosition);
            if (distanceToBall < triggerDistance) {
                if (playSituation == Situation.KICKOFF) playSituation = Situation.PLAY;
                playerArray.push([player, distanceToBall]);
            }
        }
    }
    if (playerArray.length != 0) {
        let playerTouch = playerArray.sort((a, b) => a[1] - b[1])[0][0];
        if (lastTeamTouched == playerTouch.team || lastTeamTouched == Team.SPECTATORS) {
            if (lastTouches[0] == null || (lastTouches[0] != null && lastTouches[0].player.id != playerTouch.id)) {
                game.touchArray.push(
                    new BallTouch(
                        playerTouch,
                        game.scores.time,
                        getGoalGame(),
                        ballPosition
                    )
                );
                lastTouches[0] = checkGoalKickTouch(
                    game.touchArray,
                    game.touchArray.length - 1,
                    getGoalGame()
                );
                lastTouches[1] = checkGoalKickTouch(
                    game.touchArray,
                    game.touchArray.length - 2,
                    getGoalGame()
                );
            }
        }
        lastTeamTouched = playerTouch.team;
    }
}

function getBallSpeed() {
    var ballProp = room.getDiscProperties(0);
    return Math.sqrt(ballProp.xspeed ** 2 + ballProp.yspeed ** 2) * speedCoefficient;
}

function getGameStats() {
    if (playSituation == Situation.PLAY && gameState == State.PLAY) {
        lastTeamTouched == Team.RED ? possession[0]++ : possession[1]++;
        var ballPosition = room.getBallPosition();
        ballPosition.x < 0 ? actionZoneHalf[0]++ : actionZoneHalf[1]++;
        handleGK();
    }
}

/* GOAL ATTRIBUTION FUNCTIONS */

function getGoalAttribution(team) {
    var goalAttribution = Array(2).fill(null);
    if (lastTouches[0] != null) {
        if (lastTouches[0].player.team == team) {
            // Direct goal scored by player
            if (lastTouches[1] != null && lastTouches[1].player.team == team) {
                goalAttribution = [lastTouches[0].player, lastTouches[1].player];
            } else {
                goalAttribution = [lastTouches[0].player, null];
            }
        } else {
            // Own goal
            goalAttribution = [lastTouches[0].player, null];
        }
    }
    return goalAttribution;
}

function getGoalString(team) {
    var goalString;
    var scores = game.scores;
    var goalAttribution = getGoalAttribution(team);
    if (goalAttribution[0] != null) {
        if (goalAttribution[0].team == team) {
            if (goalAttribution[1] != null && goalAttribution[1].team == team) {
                goalString = `âš½ğ—šğ—¢ğ—¢ğ—Ÿğ—Ÿğ—Ÿ â™‡${goalAttribution[0].name} (${goalAttribution[1].name})ğŸ§¤ğŸ›¡ï¸ , âŒ›${getTimeGame(scores.time)} ğŸ’¨${ballSpeed.toFixed(2)} á´‹á´/s`;
                game.goals.push(
                    new Goal(
                        scores.time,
                        team,
                        goalAttribution[0],
                        goalAttribution[1]
                    )
                );
            } else {
                goalString = `âš½ ğ—šğ—¢ğ—¢ğ—Ÿğ—Ÿğ—Ÿ! â™‡${goalAttribution[0].name}ğŸ§¤ğŸ›¡ï¸ , âŒ›${getTimeGame(scores.time)} ğŸ’¨${ballSpeed.toFixed(2)} á´‹á´/s`;
                game.goals.push(
                    new Goal(scores.time, team, goalAttribution[0], null)
                );
            }
        } else {
            goalString = `ğŸ˜¢ğ—ğ—˜ğ—¡ğ——ğ—œ ğ—ğ—”ğ—Ÿğ—˜ğ—¦ğ—œğ—¡ğ—˜! â™‡${goalAttribution[0].name}ğŸ§¤ğŸ›¡ï¸ , âŒ›${getTimeGame(scores.time)} ğŸ’¨${ballSpeed.toFixed(2)} á´‹á´/s`;
            game.goals.push(
                new Goal(scores.time, team, goalAttribution[0], null)
            );
        }
    } else {
        goalString = `âš½ ğ—šğ—¢ğ—¢ğ—Ÿğ—Ÿğ—Ÿ! âŒ›${getTimeGame(scores.time)} ğŸ’¨${ballSpeed.toFixed(2)} á´‹á´/s`;
        game.goals.push(
            new Goal(scores.time, team, null, null)
        );
    }

    return goalString;
}

/* ROOM STATS FUNCTIONS */

function updatePlayerStats(player, teamStats) {
    var stats = new HaxStatistics(player.name);
    var pComp = getPlayerComp(player);
    if (LocalStatsStorage.getItem(player.name)) {
        stats = JSON.parse(LocalStatsStorage.getItem(player.name));
    }
    stats.games++;
    if (lastWinner == teamStats) stats.wins++;
    stats.winrate = ((100 * stats.wins) / (stats.games || 1)).toFixed(1) + `%`;
    stats.goals += getGoalsPlayer(pComp);
    stats.assists += getAssistsPlayer(pComp);
    stats.ownGoals += getOwnGoalsPlayer(pComp);
    stats.CS += getCSPlayer(pComp);
    stats.playtime += getGametimePlayer(pComp);
    LocalStatsStorage.setItem(player.name, JSON.stringify(stats));
}

function updateStats() {
    if (
        players.length >= 2 * teamSize &&
        (
            game.scores.time >= (5 / 6) * game.scores.timeLimit ||
            game.scores.red == game.scores.scoreLimit ||
            game.scores.blue == game.scores.scoreLimit
        ) &&
        teamRedStats.length >= teamSize && teamBlueStats.length >= teamSize
    ) {
        for (let player of teamRedStats) {
            updatePlayerStats(player, Team.RED);
        }
        for (let player of teamBlueStats) {
            updatePlayerStats(player, Team.BLUE);
        }
    }
}

function printRankings(statKey, id = 0) {
    var leaderboard = [];
    statKey = statKey == "cs" ? "CS" : statKey;
    
    // LocalStorage'den oyuncu verilerini almak
    for (var i = 0; i < LocalStatsStorage.length; i++) {
        var key = LocalStatsStorage.key(i);
        var playerData = JSON.parse(LocalStatsStorage.getItem(key));
        leaderboard.push([
            playerData.playerName,
            playerData[statKey]
        ]);
    }

    // EÄŸer yeterli oyuncu yoksa uyarÄ±
    if (leaderboard.length < 5) {
        if (id != 0) {
            room.sendAnnouncement('âš ï¸ Odada yeterli sayÄ±da oyun oynanmadÄ±!', id, errorColor, 'bold', HaxNotification.CHAT);
        }
        return;
    }

    // Lider tablosunu sÄ±ralamak
    leaderboard.sort(function (a, b) { return b[1] - a[1]; });

    // Tablo baÅŸlÄ±klarÄ±
    var rankingString = "";
    if (statKey === "games") {
        rankingString = "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğ—˜ğ—¡ ğ—–ğ—¢ğ— ğ—¢ğ—¬ğ—¡ğ—”ğ—¬ğ—”ğ—¡ğ—Ÿğ—”ğ—¥: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
    } else if (statKey === "wins") {
        rankingString = "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğ—˜ğ—¡ ğ—–ğ—¢ğ— ğ—ğ—”ğ—­ğ—”ğ—¡ğ—”ğ—¡ğ—Ÿğ—”ğ—¥: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
    } else if (statKey === "goals") {
        rankingString = "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğ—šğ—¢ğ—Ÿ ğ—ğ—¥ğ—”ğ—Ÿğ—Ÿğ—œğ—šğ—œ: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
    } else if (statKey === "assists") {
        rankingString = "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğ—”ğ—¦ğ—œğ—¦ğ—§ ğ—ğ—¥ğ—”ğ—Ÿğ—Ÿğ—œğ—šğ—œ: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
    } else if (statKey === "cs") {
        rankingString = "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğ—˜ğ—¡ ğ—œğ—¬ğ—œ ğ—ğ—”ğ—Ÿğ—˜ğ—–ğ—œğ—Ÿğ—˜ğ—¥: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
    } else if (statKey === "playtime") {
        rankingString = "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğ—˜ğ—¡ ğ—”ğ—ğ—§ğ—œğ—™ğ—Ÿğ—˜ğ—¥: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
    }

    // Ä°lk 5 oyuncuyu listeleme
    for (let i = 0; i < 5; i++) {
        let playerName = leaderboard[i][0];
        let playerStat = leaderboard[i][1];
        if (statKey === 'playtime') {
            playerStat = getTimeStats(playerStat); // SÃ¼reyi formatla
        }
        if (statKey === 'games') {
            rankingString += `${i + 1}-) ${playerName} (${playerStat} Oyun)\n`;
        } else if (statKey === 'playtime') {
            rankingString += `${i + 1}-) ${playerName} (${playerStat})\n`;
        } else if (statKey === 'wins') {
            rankingString += `${i + 1}-) ${playerName} (${playerStat} Kazanma)\n`;
        } else if (statKey === 'goals') {
            rankingString += `${i + 1}-) ${playerName} (${playerStat} Gol)\n`;
        } else if (statKey === 'assists') {
            rankingString += `${i + 1}-) ${playerName} (${playerStat} Asist)\n`;
        } else if (statKey === 'CS') {
            rankingString += `${i + 1}-) ${playerName} (${playerStat} Gol Yenmeyen MaÃ§)\n`;
        }
        
    }
    rankingString += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`;
    // SonuÃ§larÄ± odada duyur
    room.sendAnnouncement(rankingString, id, 0x45b3cc,'small-bold', HaxNotification.CHAT);
}

/* GET STATS FUNCTIONS */

function getGamePlayerStats(player) {
    var stats = new HaxStatistics(player.name);
    var pComp = getPlayerComp(player);
    stats.goals += getGoalsPlayer(pComp);
    stats.assists += getAssistsPlayer(pComp);
    stats.ownGoals += getOwnGoalsPlayer(pComp);
    stats.playtime += getGametimePlayer(pComp);
    stats.CS += getCSPlayer(pComp);
    return stats;
}

function getGametimePlayer(pComp) {
    if (pComp == null) return 0;
    var timePlayer = 0;
    for (let j = 0; j < pComp.timeEntry.length; j++) {
        if (pComp.timeExit.length < j + 1) {
            timePlayer += game.scores.time - pComp.timeEntry[j];
        } else {
            timePlayer += pComp.timeExit[j] - pComp.timeEntry[j];
        }
    }
    return Math.floor(timePlayer);
}

function getGoalsPlayer(pComp) {
    if (pComp == null) return 0;
    var goalPlayer = 0;
    for (let goal of game.goals) {
        if (goal.striker != null && goal.team === pComp.player.team) {
            if (authArray[goal.striker.name][0] == pComp.auth) {
                goalPlayer++;
            }
        }
    }
    return goalPlayer;
}

function getOwnGoalsPlayer(pComp) {
    if (pComp == null) return 0;
    var goalPlayer = 0;
    for (let goal of game.goals) {
        if (goal.striker != null && goal.team !== pComp.player.team) {
            if (authArray[goal.striker.name][0] == pComp.auth) {
                goalPlayer++;
            }
        }
    }
    return goalPlayer;
}

function getAssistsPlayer(pComp) {
    if (pComp == null) return 0;
    var assistPlayer = 0;
    for (let goal of game.goals) {
        if (goal.assist != null) {
            if (authArray[goal.assist.name][0] == pComp.auth) {
                assistPlayer++;
            }
        }
    }
    return assistPlayer;
}

function getGKPlayer(pComp) {
    if (pComp == null) return 0;
    let GKRed = getGK(Team.RED);
    if (pComp.auth == GKRed?.auth) {
        return Team.RED;
    }
    let GKBlue = getGK(Team.BLUE);
    if (pComp.auth == GKBlue?.auth) {
        return Team.BLUE;
    }
    return Team.SPECTATORS;
}

function getCSPlayer(pComp) {
    if (pComp == null || game.scores == null) return 0;
    if (getGKPlayer(pComp) == Team.RED && game.scores.blue == 0) {
        return 1;
    } else if (getGKPlayer(pComp) == Team.BLUE && game.scores.red == 0) {
        return 1;
    }
    return 0;
}

function actionReportCountTeam(goals, team) {
    let playerActionSummaryTeam = [];
    let indexTeam = team == Team.RED ? 0 : 1;
    let indexOtherTeam = team == Team.RED ? 1 : 0;
    for (let goal of goals[indexTeam]) {
        if (goal[0] != null) {
            if (playerActionSummaryTeam.find(a => a[0].id == goal[0].id)) {
                let index = playerActionSummaryTeam.findIndex(a => a[0].id == goal[0].id);
                playerActionSummaryTeam[index][1]++;
            } else {
                playerActionSummaryTeam.push([goal[0], 1, 0, 0]);
            }
            if (goal[1] != null) {
                if (playerActionSummaryTeam.find(a => a[0].id == goal[1].id)) {
                    let index = playerActionSummaryTeam.findIndex(a => a[0].id == goal[1].id);
                    playerActionSummaryTeam[index][2]++;
                } else {
                    playerActionSummaryTeam.push([goal[1], 0, 1, 0]);
                }
            }
        }
    }
    if (goals[indexOtherTeam].length == 0) {
        let playerCS = getGK(team)?.player;
        if (playerCS != null) {
            if (playerActionSummaryTeam.find(a => a[0].id == playerCS.id)) {
                let index = playerActionSummaryTeam.findIndex(a => a[0].id == playerCS.id);
                playerActionSummaryTeam[index][3]++;
            } else {
                playerActionSummaryTeam.push([playerCS, 0, 0, 1]);
            }
        }
    }

    playerActionSummaryTeam.sort((a, b) => (a[1] + a[2] + a[3]) - (b[1] + b[2] + b[3]));
    return playerActionSummaryTeam;
}

/* FETCH FUNCTIONS */

function fetchActionsSummaryReport(game) {
    var fieldReportRed = {
        name: 'ğŸ”´**KIRMIZI TAKIM**',
        value: ' ',
        inline: true,
    };
    var fieldReportBlue = {
        name: 'ğŸ”µ**MAVÄ° TAKIM**',
        value: ' ',
        inline: true,
    };
    var goals = [[], []];
    for (let i = 0; i < game.goals.length; i++) {
        goals[game.goals[i].team - 1].push([game.goals[i].striker, game.goals[i].assist]);
    }
    var redActions = actionReportCountTeam(goals, Team.RED);
    if (redActions.length > 0) {
        for (let act of redActions) {
            fieldReportRed.value += `> **${act[0].team != Team.RED ? '[KK] ' : ''}${act[0].name}:**` +
                `${act[1] > 0 ? ` ${act[1]}G` : ''}` +
                `${act[2] > 0 ? ` ${act[2]}A` : ''}` +
                `${act[3] > 0 ? ` ${act[3]}CS` : ''}\n`;
        }
    }
    var blueActions = actionReportCountTeam(goals, Team.BLUE);
    if (blueActions.length > 0) {
        for (let act of blueActions) {
            fieldReportBlue.value += `> **${act[0].team != Team.BLUE ? '[KK] ' : ''}${act[0].name}:**` +
                `${act[1] > 0 ? ` ${act[1]}G` : ''}` +
                `${act[2] > 0 ? ` ${act[2]}A` : ''}` +
                `${act[3] > 0 ? ` ${act[3]}CS` : ''}\n`;
        }
    }

    fieldReportRed.value += `\n${blueActions.length - redActions.length > 0 ? '\n'.repeat(blueActions.length - redActions.length) : ''
        }`;
    fieldReportRed.value += '=====================';

    fieldReportBlue.value += `\n${redActions.length - blueActions.length > 0 ? '\n'.repeat(redActions.length - blueActions.length) : ''
        }`;
    fieldReportBlue.value += '=====================';

    return [fieldReportRed, fieldReportBlue];
}

function fetchSummaryEmbed(game) {
    var fetchEndgame = [fetchActionsSummaryReport];
    var logChannel = gameWebhook;
    var fields = [
        {
            name: 'ğŸ”´**KIRMIZI TAKIM**',
            value: '=====================\n\n',
            inline: true,
        },
        {
            name: 'ğŸ”µ**MAVÄ° TAKIM**',
            value: '=====================\n\n',
            inline: true,
        },
    ];
    for (let i = 0; i < fetchEndgame.length; i++) {
        var fieldsReport = fetchEndgame[i](game);
        fields[0].value += fieldsReport[0].value + '\n\n';
        fields[1].value += fieldsReport[1].value + '\n\n';
    }
    fields[0].value = fields[0].value.substring(0, fields[0].value.length - 2);
    fields[1].value = fields[1].value.substring(0, fields[1].value.length - 2);

    var possR = possession[0] / (possession[0] + possession[1]);
    var possB = 1 - possR;
    var possRString = (possR * 100).toFixed(0).toString();
    var possBString = (possB * 100).toFixed(0).toString();
    var zoneR = actionZoneHalf[0] / (actionZoneHalf[0] + actionZoneHalf[1]);
    var zoneB = 1 - zoneR;
    var zoneRString = (zoneR * 100).toFixed(0).toString();
    var zoneBString = (zoneB * 100).toFixed(0).toString();
    var win = (game.scores.red > game.scores.blue) * 1 + (game.scores.blue > game.scores.red) * 2;
    var totalPasses = Math.floor(Math.random() * 11) + 25;
    var passesRed = Math.round(totalPasses * possR);
    var passesBlue = totalPasses - passesRed;
    var objectBodyWebhook = {
        embeds: [
            {
                title: `**MAÃ‡ KAYDI (${getIdReport()})**`,
                description: 
                `**SÃœRE:** ${getTimeEmbed(game.scores.time)} \n**SKOR:** [${game.scores.red} - ${game.scores.blue}]
                \`\`\`c
Topa Sahip Olma: ${possRString}% - ${possBString}%
IsÄ± HaritasÄ±: ${zoneRString}% - ${zoneBString}%
Pas HaritasÄ±: ${passesRed} - ${passesBlue}
${win == 1 ? 'ğŸŸ¥ á´‹Ä±Ê€á´Ä±á´¢Ä± á´›á´€á´‹Ä±á´ á´‹á´€á´¢á´€É´á´…Ä±' : 'ğŸŸ¦ á´á´€á´ Éª á´›á´€á´‹Ä±á´ á´‹á´€á´¢á´€É´á´…Ä±'}\`\`\`
                `,                
            color: 9567999,
                fields: fields,
                footer: {
                    text: ` Haxball Oyun KayÄ±t Sistemi`,
                },
                timestamp: new Date().toISOString(),
            },
        ],
        username: " Bot"
    };
    if (logChannel != '') {
        fetch(logChannel, {
            method: 'POST',
            body: JSON.stringify(objectBodyWebhook),
            headers: {
                'Content-Type': 'application/json',
            },
        }).then((res) => res);
    }
}

/* EVENTS */

/* PLAYER MOVEMENT */

room.onPlayerJoin = function (player) {
    authArray[player.name] = [player.auth, player.conn];
    if (isAdmin(player) || isMaster(player)) {
        afkCommand(player,"!afk")
    }
    if (roomWebhook != '') {
        fetch(roomWebhook, {
            method: 'POST',
            body: JSON.stringify({
                content: `**ğŸŸ© ${player.name} odaya baÄŸlandÄ±.**`,
                username: roomName,
            }),
            headers: {
                'Content-Type': 'application/json',
            },
        }).then((res) => res);
    }
    const isBanned = banList.some((bannedPlayer) => bannedPlayer[0] === player.name);
    if (isBanned) {
        // EÄŸer oyuncu banlanmÄ±ÅŸsa, odaya girmesini engelle
        room.kickPlayer(player.id, "Odadan banlanmÄ±ÅŸsÄ±nÄ±z. KaldÄ±rmak iÃ§in Discord'a gelip destek talebi oluÅŸturmalÄ±sÄ±nÄ±z: " + discordLink, true);
    }
    room.sendAnnouncement(
        `ğŸ’¬ ğ—›ğ—¢ğ—¦ ğ—šğ—˜ğ—Ÿğ——ğ—œğ—¡ ${player.name}, ğŸ”·!á´‹á´á´á´œá´›ÊŸá´€Ê€ ğŸ”·!á´€á´…á´ÉªÉ´á´„á´€É¢ÉªÊ€ ğŸ‘¥ğ——ğ—œğ—¦ğ—–ğ—¢ğ—¥ğ—— : ${discordLink}`,
        null,
        welcomeColor,
        'normal',
        1
    );
    updateTeams();
    updateAdmins();
    if (masterList.findIndex((auth) => auth == player.auth) != -1) {
        room.sendAnnouncement(
            `âšœï¸ ğ“¨ğ“ğ“ğ“”ğ“£ğ“˜ğ“’ğ“˜ âšœï¸ á´á´…á´€Êá´€ Ê™á´€É¢ÊŸá´€É´á´…Ä±.`,
            null,
            yÃ¶neticiColor,
            'bold',
            HaxNotification.CHAT
        );
        room.setPlayerAdmin(player.id, true);
    } else if (adminList.map((a) => a[0]).findIndex((auth) => auth == player.auth) != -1) {
        room.sendAnnouncement(
            `ğŸ”° ğ“œğ“ğ““ğ“”ğ“¡ğ“ğ“£ğ“ğ“¡ ğŸ”° á´á´…á´€Êá´€ Ê™á´€É¢ÊŸá´€É´á´…Ä±.`,
            null,
            moderatorColor,
            'bold',
            HaxNotification.CHAT
        );
        room.setPlayerAdmin(player.id, true);
    }
    var sameAuthCheck = playersAll.filter((p) => p.id != player.id && authArray[p.name][0] == player.auth);
    if (sameAuthCheck.length > 0 && !debugMode) {
        var oldPlayerArray = playersAll.filter((p) => p.id != player.id && authArray[p.name][0] == player.auth);
        for (let oldPlayer of oldPlayerArray) {
            ghostKickHandle(oldPlayer, player);
        }
    }
    handlePlayersJoin();
    onJoinProfile(player);
};

room.onPlayerTeamChange = function (changedPlayer, byPlayer) {
    handleLineupChangeTeamChange(changedPlayer);
    if (AFKSet.has(changedPlayer.id) && changedPlayer.team != Team.SPECTATORS) {
        room.setPlayerTeam(changedPlayer.id, Team.SPECTATORS);
        room.sendAnnouncement(
            `âš ï¸ ${changedPlayer.name} isimli oyuncu AFK olduÄŸu iÃ§in takÄ±mÄ±nÄ± deÄŸiÅŸtiremezsin !`,
            null,
            errorColor,
            'bold',
            HaxNotification.CHAT
        );
        return;
    }
    updateTeams();
    if (gameState != State.STOP) {
        if (changedPlayer.team != Team.SPECTATORS && game.scores.time <= (3 / 4) * game.scores.timeLimit && Math.abs(game.scores.blue - game.scores.red) < 2) {
            changedPlayer.team == Team.RED ? teamRedStats.push(changedPlayer) : teamBlueStats.push(changedPlayer);
        }
    }
    handleActivityPlayerTeamChange(changedPlayer);
    handlePlayersTeamChange(byPlayer);
};

room.onPlayerLeave = function (player) {
    let playerData = LocalProfilesStorage.getItem(player.name);
    if (playerData) {
        playerData = JSON.parse(playerData);  // JSON string'i objeye Ã§evir
        if (playerData.loggedIn) {
            playerData.loggedIn = false;  // GiriÅŸ durumu false olarak gÃ¼ncelleniyor
            LocalProfilesStorage.setItem(player.name, JSON.stringify(playerData));  // GÃ¼ncellenmiÅŸ veriyi JSON string olarak kaydediyoruz
        }
    }
    setTimeout(() => {
        if (roomWebhook != '') {
            var stringContent = `**ğŸŸ¥ ${player.name} odadan ayrÄ±ldÄ±.**`;
            fetch(roomWebhook, {
                method: 'POST',
                body: JSON.stringify({
                    content: stringContent,
                    username: roomName,
                }),
                headers: {
                    'Content-Type': 'application/json',
                },
            }).then((res) => res);
        }
    }, 10);
    handleLineupChangeLeave(player);
    checkCaptainLeave(player);
    updateTeams();
    updateAdmins();
    handlePlayersLeave();
};

room.onPlayerKicked = function (kickedPlayer, reason, ban, byPlayer) {
    kickFetchVariable = true;
    if (ban && byPlayer) {
        // Ban iÅŸlemi iÃ§in webhook gÃ¶nderimi
        if (banWebhook != '') {
            fetch(banWebhook, {
                method: 'POST',
                body: JSON.stringify({
                    username: "Ban Ä°ÅŸlemi",
                    embeds: [{
                        title: "BAN Ä°ÅLEMÄ°",
                        description: `\`${kickedPlayer.name}\` adlÄ± oyuncu banlandÄ±.`,
                        color: 15158332, // Embed rengi (KÄ±rmÄ±zÄ±, ban iÃ§in)
                        fields: [
                            {
                                name: "**Banlanan Oyuncu**",
                                value: `#${kickedPlayer.id} ${kickedPlayer.name}`,
                                inline: true
                            },
                            {
                                name: "**Banlayan Yetkili**",
                                value: `#${byPlayer.id} ${byPlayer.name}`,
                                inline: true
                            },
                            {
                                name: "**Sebep**",
                                value: reason || "Sebep belirtilmemiÅŸ",
                                inline: false
                            }
                        ],
                        timestamp: new Date(),
                    }]
                }),
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then((res) => res)
            .catch((err) => {
                console.error('Webhook gÃ¶nderilirken bir hata oluÅŸtu:', err);
            });
        }
    } else if (ban) {
        if (banWebhook != '') {
            fetch(banWebhook, {
                method: 'POST',
                body: JSON.stringify({
                    username: "Ban Ä°ÅŸlemi",
                    embeds: [{
                        title: "BAN Ä°ÅLEMÄ°",
                        description: `\`${kickedPlayer.name}\` adlÄ± oyuncu banlandÄ±.`,
                        color: 15158332, // Embed rengi (KÄ±rmÄ±zÄ±, ban iÃ§in)
                        fields: [
                            {
                                name: "**Banlanan Oyuncu**",
                                value: `#${kickedPlayer.id} ${kickedPlayer.name}`,
                                inline: true
                            },
                            {
                                name: "**Banlayan Yetkili**",
                                value: `SÄ°STEM TARAFINDAN BANLANDI`,
                                inline: true
                            },
                            {
                                name: "**Sebep**",
                                value: reason || "Sebep belirtilmemiÅŸ",
                                inline: false
                            }
                        ],
                        timestamp: new Date(),
                    }]
                }),
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then((res) => res)
            .catch((err) => {
                console.error('Webhook gÃ¶nderilirken bir hata oluÅŸtu:', err);
            });
        }
    }
    if ((ban && ((byPlayer != null &&
        (byPlayer.id == kickedPlayer.id || getRole(byPlayer) < Role.MASTER)) || getRole(kickedPlayer) == Role.MASTER)) || disableBans
    ) {
        room.clearBan(kickedPlayer.id);
        return;
    }
    if (byPlayer != null && getRole(byPlayer) < Role.ADMIN_PERM) {
        room.sendAnnouncement(
            'âš ï¸ Kick / Ban yetkin yok !',
            byPlayer.id,
            errorColor,
            'bold',
            HaxNotification.CHAT
        );
        room.setPlayerAdmin(byPlayer.id, false);
        return;
    }
    if (ban) banList.push([kickedPlayer.name, kickedPlayer.id]);
    listeleriGÃ¼ncelle()
};

/* PLAYER ACTIVITY */

room.onPlayerChat = function (player, message) {
    if (gameState !== State.STOP && player.team != Team.SPECTATORS) {
        let pComp = getPlayerComp(player);
        if (pComp != null) pComp.inactivityTicks = 0;
    }
    let msgArray = message.split(/ +/);
    if (!message.startsWith("!")) {
        if (roomWebhook != '')
            fetch(roomWebhook, {
                method: 'POST',
                body: JSON.stringify({
                    content: `**${player.name}** : ${message.replace('@', '@ ')}`,
                    username: roomName,
                }),
                headers: {
                    'Content-Type': 'application/json',
                },
            }).then((res) => res);
    }
    if (msgArray[0][0] == '!') {
        let command = getCommand(msgArray[0].slice(1).toLowerCase());
        if (command != false && commands[command].roles <= getRole(player)) commands[command].function(player, message);
        else
            room.sendAnnouncement(
                `âš ï¸ GirdiÄŸin komut geÃ§ersiz. KullanÄ±labilir komutlarÄ± gÃ¶rmek iÃ§in '!komutlar' kullan.`,
                player.id,
                errorColor,
                'bold',
                HaxNotification.CHAT
            );
        return false;
    }
    if (msgArray[0].toLowerCase() == 't') {
        teamChat(player, message);
        return false;
    }
    if (chooseMode && teamRed.length * teamBlue.length != 0) {
        var choosingMessageCheck = chooseModeFunction(player, message);
        if (choosingMessageCheck) return false;
    }
    if (slowMode > 0) {
        var filter = slowModeFunction(player, message);
        if (filter && !isSpecial) {
            room.sendAnnouncement(
                `${player.name}: ${message} (Bu mesajÄ± sadece siz gÃ¶rebilirsiniz)`,
                player.id,
                0xffffff,
                'normal',
                HaxNotification.CHAT
            );
            room.sendAnnouncement(
                `ğŸ’¬ YavaÅŸlatÄ±lmÄ±ÅŸ chat modu devrede.`,
                player.id,
                welcomeColor,
                'bold',
                HaxNotification.CHAT
            );
            return false;
        }
    }
    if (!player.admin && muteArray.getByAuth(authArray[player.name][0]) != null) {
        room.sendAnnouncement(
            `âš ï¸ SusturulmuÅŸsun !`,
            player.id,
            errorColor,
            'bold',
            HaxNotification.CHAT
        );
        return false;
    }
    if (masterList.findIndex((auth) => auth == authArray[player.name][0]) != -1) {
        room.sendAnnouncement(
            `âšœï¸ ${player.name}: ${message}`,
            null,
            yÃ¶neticiColor,
            'bold',
            HaxNotification.CHAT
        );
        return false
    } else if (adminList.map((a) => a[0]).findIndex((auth) => auth == authArray[player.name][0]) != -1) {
        room.sendAnnouncement(
            `ğŸ”° ${player.name}: ${message}`,
            null,
            moderatorColor,
            'bold',
            HaxNotification.CHAT
        );
        return false
    } else {
        room.sendAnnouncement(
            `[${rutbeCommand(player)}] ${player.name}: ${message}`,
            null,
            0xffffff,
            'normal',
            HaxNotification.CHAT
        );
        return false
    }
};

room.onPlayerActivity = function (player) {
    if (gameState !== State.STOP) {
        let pComp = getPlayerComp(player);
        if (pComp != null) pComp.inactivityTicks = 0;
    }
};

room.onPlayerBallKick = function (player) {
    let team = player.team
    if (team === 1) {
        room.setDiscProperties(0,{colors: redColor})
    } else if (team === 2) {
        room.setDiscProperties(0,{colors: blueColor})
    }
    if (playSituation != Situation.GOAL) {
        var ballPosition = room.getBallPosition();
        if (game.touchArray.length == 0 || player.id != game.touchArray[game.touchArray.length - 1].player.id) {
            if (playSituation == Situation.KICKOFF) playSituation = Situation.PLAY;
            lastTeamTouched = player.team;
            game.touchArray.push(
                new BallTouch(
                    player,
                    game.scores.time,
                    getGoalGame(),
                    ballPosition
                )
            );
            lastTouches[0] = checkGoalKickTouch(
                game.touchArray,
                game.touchArray.length - 1,
                getGoalGame()
            );
            lastTouches[1] = checkGoalKickTouch(
                game.touchArray,
                game.touchArray.length - 2,
                getGoalGame()
            );
        }
    }
};

/* GAME MANAGEMENT */

room.onGameStart = function (byPlayer) {
    clearTimeout(startTimeout);
    if (byPlayer != null) clearTimeout(stopTimeout);
    game = new Game();
    possession = [0, 0];
    actionZoneHalf = [0, 0];
    gameState = State.PLAY;
    endGameVariable = false;
    goldenGoal = false;
    playSituation = Situation.KICKOFF;
    lastTouches = Array(2).fill(null);
    lastTeamTouched = Team.SPECTATORS;
    teamRedStats = [];
    teamBlueStats = [];
    if (teamRed.length == teamSize && teamBlue.length == teamSize) {
        for (var i = 0; i < teamSize; i++) {
            teamRedStats.push(teamRed[i]);
            teamBlueStats.push(teamBlue[i]);
        }
    }
    calculateStadiumVariables();
};

room.onGameStop = function (byPlayer) {
    clearTimeout(stopTimeout);
    clearTimeout(unpauseTimeout);
    if (byPlayer != null) clearTimeout(startTimeout);
    game.rec = room.stopRecording();
    if (
        !cancelGameVariable && game.playerComp[0].length + game.playerComp[1].length > 0 &&
        (
            (game.scores.timeLimit != 0 &&
                ((game.scores.time >= 0.5 * game.scores.timeLimit &&
                    game.scores.time < 0.75 * game.scores.timeLimit &&
                    game.scores.red != game.scores.blue) ||
                    game.scores.time >= 0.75 * game.scores.timeLimit)
            ) ||
            endGameVariable
        )
    ) {
        fetchSummaryEmbed(game);
        if (fetchRecordingVariable) {
            setTimeout((gameEnd) => { fetchRecording(gameEnd); }, 500, game);
            room.sendAnnouncement(`ğŸ¬ MaÃ§ KaydÄ± Discord'a gÃ¶nderildi. KayÄ±t NumarasÄ±: ${getIdReport()}`,null,0xffffff,"bold",2)
        }
    }
    cancelGameVariable = false;
    gameState = State.STOP;
    playSituation = Situation.STOP;
    updateTeams();
    handlePlayersStop(byPlayer);
    handleActivityStop();
};

room.onGamePause = function (byPlayer) {
    if (mentionPlayersUnpause && gameState == State.PAUSE) {
        if (byPlayer != null) {
            room.sendAnnouncement(
                `Oyun durduruldu (${byPlayer.name})`,
                null,
                defaultColor,
                'bold',
                HaxNotification.NONE
            );
        } else {
            room.sendAnnouncement(
                `Oyun durduruldu`,
                null,
                defaultColor,
                'bold',
                HaxNotification.NONE
            );
        }
    }
    clearTimeout(unpauseTimeout);
    gameState = State.PAUSE;
};

room.onGameUnpause = function (byPlayer) {
    unpauseTimeout = setTimeout(() => {
        gameState = State.PLAY;
    }, 2000);
    if (mentionPlayersUnpause) {
        if (byPlayer != null) {
            room.sendAnnouncement(
                `Oyun devam ettirildi (${byPlayer.name})`,
                null,
                defaultColor,
                'bold',
                HaxNotification.NONE
            );
        } else {
            room.sendAnnouncement(
                `Oyun devam ettirildi`,
                null,
                defaultColor,
                'bold',
                HaxNotification.NONE
            );
        }
    }
    if (
        (teamRed.length == teamSize && teamBlue.length == teamSize && chooseMode) ||
        (teamRed.length == teamBlue.length && teamSpec.length < 2 && chooseMode)
    ) {
        deactivateChooseMode();
    }
};

room.onTeamGoal = function (team) {
    const scores = room.getScores();
    game.scores = scores;
    playSituation = Situation.GOAL;
    ballSpeed = getBallSpeed();
    var goalString = getGoalString(team);
    for (let player of teamRed) {
        var playerComp = getPlayerComp(player);
        team == Team.RED ? playerComp.goalsScoredTeam++ : playerComp.goalsConcededTeam++;
    }
    for (let player of teamBlue) {
        var playerComp = getPlayerComp(player);
        team == Team.BLUE ? playerComp.goalsScoredTeam++ : playerComp.goalsConcededTeam++;
    }
    room.sendAnnouncement(
        goalString,
        null,
        0xffffff,
        "normal",
        HaxNotification.CHAT
    );
    if ((scores.scoreLimit != 0 && (scores.red == scores.scoreLimit || scores.blue == scores.scoreLimit)) || goldenGoal) {
        endGame(team);
        goldenGoal = false;
        stopTimeout = setTimeout(() => {
            room.stopGame();
        }, 1000);
    }
};

room.onPositionsReset = function () {
    lastTouches = Array(2).fill(null);
    lastTeamTouched = Team.SPECTATORS;
    playSituation = Situation.KICKOFF;
};

/* MISCELLANEOUS */


let currentAnnouncementIndex = 0;
 
 


function dcLinkGÃ¶nder(player) {
    room.sendAnnouncement(`â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯ â€¯â–’â–ˆâ–€â–€â–„ â–€â–ˆâ–€ â–’â–ˆâ–€â–€â–€â–ˆ â–’â–ˆâ–€â–€â–ˆ â–’â–ˆâ–€â–€â–€â–ˆ â–’â–ˆâ–€â–€â–ˆ â–’â–ˆâ–€â–€â–„`,player.id,0x5e85fe,"bold",0);
    room.sendAnnouncement(`â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯ â€¯â–’â–ˆâ–‘â–’â–ˆ â–’â–ˆâ–‘ â–‘â–€â–€â–€â–„â–„ â–’â–ˆâ–‘â–‘â–‘ â–’â–ˆâ–‘â–‘â–’â–ˆ â–’â–ˆâ–„â–„â–€ â–’â–ˆâ–‘â–’â–ˆ`,player.id,0x7e76ff,"bold",0);
    room.sendAnnouncement(`â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯ â€¯â–’â–ˆâ–„â–„â–€ â–„â–ˆâ–„ â–’â–ˆâ–„â–„â–„â–ˆ â–’â–ˆâ–„â–„â–ˆ â–’â–ˆâ–„â–„â–„â–ˆ â–’â–ˆâ–‘â–’â–ˆ â–’â–ˆâ–„â–„â–€`,player.id,0x9f66fe,"bold",0);
    room.sendAnnouncement(`â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯â€¯â€¯â€¯â€¯ â€¯â€¯â€¯â€¯ ğŸŸ£ á‘Oá¯á—© Ailesine KatÄ±l â¡ ${discordLink}â¬…`,player.id,0x9f66fe,"bold",2);
}

function sendAnnouncements() {
    if (announcementList.length === 0) {
        console.error("Duyuru listesi boÅŸ! LÃ¼tfen duyuru ekleyin.");
        return;
    }
    const duyuruString = announcementList[currentAnnouncementIndex];

    room.sendAnnouncement(
        `ğŸ“¢ ${duyuruString}`,
        null,
        0xcbfe65,
        "bold",
        2
    );

    currentAnnouncementIndex = (currentAnnouncementIndex + 1) % announcementList.length; 
}

room.onRoomLink = function (url) {
    room.setTeamColors(1, 45, 0xD0D0D0, [0x6A0000, 0x780000, 0x820000])
    room.setTeamColors(2, 45, 0xAEAEAE, [0x010053, 0x01005F, 0x010068])
    setInterval(sendAnnouncements, 3 * 60 * 1000); // 3 dakikada bir duyuru yapacak
    console.log(`${url}\nYÃ¶netici Åifresi : ${masterPassword}`);
    listeleriYÃ¼kleYadaOluÅŸtur()
    setInterval(listeleriYÃ¼kle, 5 * 1000);
    roomLink = url
};

room.onPlayerAdminChange = function (changedPlayer, byPlayer) {
    updateTeams();
    if (!changedPlayer.admin && getRole(changedPlayer) >= Role.ADMIN_TEMP) {
        room.setPlayerAdmin(changedPlayer.id, true);
        return;
    }
    updateAdmins(byPlayer != null && !changedPlayer.admin && changedPlayer.id == byPlayer.id ? changedPlayer.id : 0);
};



room.onStadiumChange = function (newStadiumName, byPlayer) {
    if (byPlayer !== null) {
        if (getRole(byPlayer) < Role.MASTER && currentStadium != 'diÄŸermap') {
            room.sendAnnouncement(
                `âš ï¸ Stadyumu manuel olarak deÄŸiÅŸtiremezsin.`,
                byPlayer.id,
                errorColor,
                'bold',
                HaxNotification.CHAT
            );
            stadiumCommand(emptyPlayer, `!${currentStadium}`);
        } else {
            room.sendAnnouncement(
                `ğŸ“¢ Stadyum deÄŸiÅŸtirildi.`,
                byPlayer.id,
                infoColor,
                'bold',
                HaxNotification.CHAT
            );
            currentStadium = 'diÄŸermap';
        }
    }
    checkStadiumVariable = true;
};

room.onGameTick = function () {
    checkTime();
    getLastTouchOfTheBall();
    getGameStats();
    handleActivity();
    
};


});


/*â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ BOT KOMUTLARI â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ*/
client.once('ready', () => {
    console.log('Bot hazÄ±r!');
    client.application.commands.set([
        new SlashCommandBuilder()
            .setName('mesajgÃ¶nder')
            .setDescription('Belirtilen odaya mesaj gÃ¶nderir.')
            .addStringOption(option =>
                option.setName('mesaj')
                    .setDescription('GÃ¶ndermek istediÄŸiniz mesajÄ± yazÄ±n')
                    .setRequired(true)
            )
            .toJSON(),
        new SlashCommandBuilder()
            .setName('oyuncular')
            .setDescription('Haxball odasÄ±ndaki oyuncularÄ± listeler')
            .toJSON(),
        new SlashCommandBuilder()
            .setName('oyuncuyuat')
            .setDescription('Haxball odasÄ±ndan oyuncuyu atar.')
            .addIntegerOption(option =>
                option
                    .setName('id')
                    .setDescription('Oyuncunun ID`si bilmiyorsa /oyuncular ile bakabilirsin.')
                    .setRequired(true)
            )
            .addStringOption(option =>
                option
                    .setName('ban')
                    .setDescription('`evet` yazarsan banlanÄ±r `hayÄ±r` yazarsan banlanmaz')
                    .setRequired(true)
            )
            .addStringOption(option =>
                option
                    .setName('sebep')
                    .setDescription('BAN/KICK sebebi girilmeli.')
                    .setRequired(true)
            )
            .toJSON(),        
        new SlashCommandBuilder()
            .setName('odalinki')
            .setDescription('Belirtilen odanÄ±n linkini alÄ±r')
            .toJSON(),
        new SlashCommandBuilder()
            .setName('odanickim')
            .setDescription('Haxball nicki ve ÅŸifresi ile Discord hesabÄ±nÄ± eÅŸleÅŸtirir.')
            .addStringOption(option =>
                option.setName('nick')
                    .setDescription('Haxball nickinizi girin.')
                    .setRequired(true)
            )
            .toJSON(),
        new SlashCommandBuilder()
            .setName('temizle')
            .setDescription('Belirtilen sayÄ± kadar mesaj temizler')
            .addStringOption(option =>
                option.setName('sayÄ±')
                    .setDescription('Silinecek mesaj sayÄ±sÄ±nÄ± girin.')
                    .setRequired(true)
            ).toJSON(),
        new SlashCommandBuilder()
            .setName('odanickimne')
            .setDescription('Haxball oda nickinizi gÃ¶sterir.').toJSON(),
        new SlashCommandBuilder()
            .setName('rank')
            .setDescription('Haxball oda rankÄ±nÄ±zÄ± gÃ¶sterir.').toJSON(),
       
            
    ]);


});

client.on('interactionCreate', async (interaction) => {
    if (interaction.isCommand()) {
        const { commandName } = interaction;

        const nick = interaction.options.getString('nick');
        const discordId = interaction.user.id;
    
        // interaction.member.roles.cache.has(ADMIN_ROLE_ID)
    
        if (commandName === 'mesajgÃ¶nder') {
            if (interaction.member.roles.cache.has(ADMIN_ROLE_ID)) {
                const mesaj = interaction.options.getString('mesaj');

                let room = client.room
                room.sendAnnouncement(mesaj, null, 0xcbfe65, "bold", 2);
                await interaction.reply(`\`\`\`${roomName} isimli odaya mesaj gÃ¶nderildi: ${mesaj}\`\`\``);
            } else {
                await interaction.reply({
                    content: 'Yetkiniz yok! Bu komutu sadece adminler kullanabilir.',
                    ephemeral: true,
                });
            }
        }else if (commandName === 'odalinki') {
            if (interaction.member.roles.cache.has(ADMIN_ROLE_ID)) {
                const url = roomLink; // Oda linki deÄŸiÅŸkeni
        
                // Embed oluÅŸturuluyor
                const embed = new EmbedBuilder()
                    .setColor(0x3498db) // Renk ayarÄ±
                    .setTitle('Oda Linki') // Embed baÅŸlÄ±ÄŸÄ±
                    .setDescription(`${roomName}`) // AÃ§Ä±klama
                    .addFields(
                        { name: 'ğŸ”— Oda Linki', value: `[Odaya BaÄŸlan](${url})`, inline: false }
                    )
                    .setFooter({ text: ' Haxball OdalarÄ±' })
                    .setTimestamp(); // MesajÄ±n zamanÄ± eklenir
        
                await interaction.reply({ embeds: [embed] });
            } else {
                await interaction.reply({
                    content: 'Yetkiniz yok! Bu komutu sadece adminler kullanabilir.',
                    ephemeral: true,
                });
            }
        }
         else if (commandName === 'odanickim') {
            // LocalProfilesStorage'den nick ile ilgili veriyi alÄ±yoruz
            const playerDataNick = LocalProfilesStorage.getItem(nick);
            playerData = JSON.parse(playerDataNick);
    
            if (!playerData) {
                // EÄŸer nick bulunamazsa, kullanÄ±cÄ±ya kayÄ±t olmalarÄ±nÄ± hatÄ±rlatÄ±yoruz
                await interaction.reply('Bu nick ile kayÄ±tlÄ± bir hesap bulunamadÄ±. LÃ¼tfen haxball odalarÄ±mÄ±zda kayÄ±t olun.');
                return;
            }
    
            // EÄŸer oyuncu kaydolmuÅŸsa, ÅŸifresini kontrol ediyoruz
            if (playerData.registered == true) {
                    // Åifre doÄŸru ise, Discord ID ve nick'i LocalDiscordProfilesStorage'a kaydediyoruz
    
                    // Zaten Discord ID ile profil var mÄ± kontrol et
                    const discordProfile = LocalDiscordProfilesStorage.getItem(discordId);
                    if (discordProfile) {
                        await interaction.reply('Oda nickini zaten seÃ§miÅŸsin.');
                        return;
                    }
    
                    // Zaten nick ile profil var mÄ± kontrol et
                    const existingNickProfile = LocalDiscordProfilesStorage.getItem(nick);
                    if (existingNickProfile) {
                        await interaction.reply('Bu nick zaten bir Discord profili ile eÅŸleÅŸtirilmiÅŸ.');
                        return;
                    }
    
                    // EÅŸleÅŸme baÅŸarÄ±lÄ±, profili kaydediyoruz
                    const profile = { nick: nick, discordId: discordId };
    
                    // Nesneyi JSON string'e dÃ¶nÃ¼ÅŸtÃ¼rerek kaydet
                    LocalDiscordProfilesStorage.setItem(discordId, JSON.stringify(profile));
                    await interaction.reply(`\`\`\`Haxball ve Discord hesabÄ±nÄ±z eÅŸleÅŸtirildi. Haxball Nickiniz: ${nick}\`\`\``);
            } else {
                // EÄŸer oyuncu kaydedilmemiÅŸse
                await interaction.reply('```Bu hesap kaydedilmemiÅŸ. LÃ¼tfen Ã¶nce kayÄ±t olun.```');
            }
        } else if (commandName === 'temizle') {
            // Sadece admin ya da uygun yetkili rolÃ¼ kontrol edin
            if (!interaction.member.permissions.has('MANAGE_MESSAGES')) {
                await interaction.reply({
                    content: '```MesajlarÄ± silme yetkiniz yok!```',
                    ephemeral: true,
                });
                return;
            }
    
            // 'sayÄ±' parametresini alÄ±yoruz
            const numberOfMessages = interaction.options.getString('sayÄ±');
    
            // Parametreyi integer'a Ã§eviriyoruz
            const amount = parseInt(numberOfMessages, 10);
    
            if (isNaN(amount) || amount <= 0 || amount > 100) {
                await interaction.reply({
                    content: '```LÃ¼tfen 1 ile 100 arasÄ±nda geÃ§erli bir sayÄ± girin.```',
                    ephemeral: true,
                });
                return;
            }
    
            // MesajlarÄ± temizleme iÅŸlemi
            try {
                const messages = await interaction.channel.messages.fetch({ limit: amount });
                await interaction.channel.bulkDelete(messages, true);
                await interaction.reply({
                    content: `\`\`\`${amount} adet mesaj baÅŸarÄ±yla silindi.\`\`\``,
                    ephemeral: true,
                });
            } catch (error) {
                console.error(error);
                await interaction.reply({
                    content: '```MesajlarÄ± silerken bir hata oluÅŸtu.```',
                    ephemeral: true,
                });
            }
        } else if (commandName === 'rank') {
            const discordId = interaction.user.id; // KullanÄ±cÄ±nÄ±n Discord ID'si
            const discordProfile = LocalDiscordProfilesStorage.getItem(discordId);
        
            // KullanÄ±cÄ± eÅŸleÅŸtirilmiÅŸ mi kontrol et
            if (!discordProfile) {
                await interaction.reply({
                    content: 'Haxball hesabÄ±nÄ±z Discord ile eÅŸleÅŸtirilmemiÅŸ. LÃ¼tfen Ã¶nce /odanickim komutunu kullanarak hesabÄ±nÄ±zÄ± baÄŸlayÄ±n.',
                    ephemeral: true,
                });
                return;
            }
        
            const { nick } = JSON.parse(discordProfile); // EÅŸleÅŸtirilmiÅŸ Haxball nick'i
        
            // Oyuncunun istatistiklerini al
            const playerStatsData = LocalStatsStorage.getItem(nick);
            if (!playerStatsData) {
                await interaction.reply({
                    content: `Oyuncu "${nick}" iÃ§in kayÄ±tlÄ± istatistik bulunamadÄ±.`,
                    ephemeral: true,
                });
                return;
            }
        
            const stats = JSON.parse(playerStatsData);
        
            // Ä°statistikleri hesapla
            const losses = stats.games - stats.wins;
            const points = (stats.wins * 15) + (losses * -10) + (stats.goals * 5) + (stats.assists * 3) + (stats.ownGoals * -3) + (stats.CS * 5);
            const winrate = ((stats.wins / stats.games) * 100).toFixed(2);
        
            // RÃ¼tbe hesaplama
            let rankTitle;
            if (points <= 500) {
                rankTitle = 'á´€É¢ÉªÊ€ á´€á´„á´‡á´Éª';
            } else if (points <= 1000) {
                rankTitle = 'á´€á´„á´‡á´Éª';
            } else if (points <= 2000) {
                rankTitle = 'á´Ê€á´›á´€';
            } else if (points <= 5000) {
                rankTitle = 'á´˜Ê€á´';
            } else if (points <= 10000000) {
                rankTitle = 'Êœá´˜';
            } else {
                rankTitle = 'Ê€á´œá´›Ê™á´‡êœ±Éªá´¢';
            }
        
            // Embed oluÅŸtur
            const embed = new EmbedBuilder()
                .setColor(0x3498db)
                .setTitle(`ğŸ“Š ${nick} Ä°statistikleri`)
                .setThumbnail('https://www.saganetwork.net/en/assets/images/game-pricing/haxball/haxball.webp')
                .setDescription(`${nick} isimli oyuncunun performansÄ±nÄ± bir bakÄ±ÅŸta keÅŸfedin!`)
                .addFields(
                    { 
                        name: 'Ä°statistikler', 
                        value: `\`\`\`
ğ—šğ—˜ğ—¡ğ—˜ğ—Ÿ
MaÃ§: ${stats.games}
Galibiyet: ${stats.wins}
MaÄŸlubiyet: ${losses}
Kazanma OranÄ±: %${winrate}
    
ğ—£ğ—˜ğ—¥ğ—™ğ—¢ğ—¥ğ— ğ—”ğ—¡ğ—¦
Gol: ${stats.goals}
Asist: ${stats.assists}
CS: ${stats.CS}
Kendi Kalesine: ${stats.ownGoals}
        \`\`\`` 
                    },
                    { 
                        name: 'Puan ve RÃ¼tbe', 
                        value: `\`\`\`css
Puan: ${points}     
    
RÃ¼tbe: ${rankTitle}
        \`\`\``
                    }
                )
                .setFooter({ text: ' Rank Sistemi' });
        
            await interaction.reply({ embeds: [embed] });
        } else if (commandName === 'odanickimne') {
            const discordId = interaction.user.id; // KullanÄ±cÄ±nÄ±n Discord ID'si
        
            // KullanÄ±cÄ±nÄ±n Discord ID'sine gÃ¶re kaydedilen Haxball profili bilgilerini al
            const discordProfile = LocalDiscordProfilesStorage.getItem(discordId);
        
            // EÄŸer profil bulunamazsa, kullanÄ±cÄ±ya hata mesajÄ± gÃ¶nder
            if (!discordProfile) {
                await interaction.reply({
                    content: '```Haxball hesabÄ±nÄ±z Discord ile eÅŸleÅŸtirilmemiÅŸ. LÃ¼tfen Ã¶nce Haxball nick\'inizi /odanickim ile kaydedin.```',
                    ephemeral: true,
                });
                return;
            }
        
            // Kaydedilen nick'i JSON formatÄ±nda parse et
            const { nick } = JSON.parse(discordProfile);
        
            // Kaydedilen nick'i kullanÄ±cÄ±ya gÃ¶ster
            await interaction.reply({
                content: `\`\`\`Odalarda kayÄ±tlÄ± nick\'iniz: ${nick}\`\`\``,
            });
        } else if (commandName === 'oyuncular') {
            if (!interaction.member.roles.cache.has(ADMIN_ROLE_ID)) {
                await interaction.reply({
                    content: 'Sadece adminler kullanabilir.',
                    ephemeral: true,
                });
                return false
            }
            if (interaction.member.roles.cache.has(ADMIN_ROLE_ID)) {
            try {
                let room = client.room
                if (!room) {
                    await interaction.reply({
                        content: `Oda bulunamadÄ±.`,
                        ephemeral: true,
                    });
                    return;
                }
        
                const players = room.getPlayerList(); // Oda oyuncularÄ±nÄ±n listesi
        
                if (players.length === 0) {
                    await interaction.reply({
                        content: `Oda ÅŸu anda boÅŸ.`,
                        ephemeral: true,
                    });
                    return;
                }
        
                // OyuncularÄ± takÄ±mlarÄ±na gÃ¶re ayÄ±rÄ±yoruz
                const redTeam = players.filter(player => player.team === 1);
                const blueTeam = players.filter(player => player.team === 2);
                const spectators = players.filter(player => player.team === 0);
        
                // Oyuncu listesini hazÄ±rlÄ±yoruz
                const formatPlayer = player => 
                    `[#${player.id}] ${player.name}${player.admin ? ' (ModeratÃ¶r)' : ''}`;
        
                const redList = redTeam.map(formatPlayer).join('\n') || 'ğŸ”´ KÄ±rmÄ±zÄ± takÄ±mda oyuncu yok.';
                const blueList = blueTeam.map(formatPlayer).join('\n') || 'ğŸ”µ Mavi takÄ±mda oyuncu yok.';
                const spectatorList = spectators.map(formatPlayer).join('\n') || 'ğŸ‘€ Ä°zleyici yok.';
        
                // Mesaj iÃ§in embed oluÅŸturuluyor
                const embed = new EmbedBuilder()
                    .setColor(0x3498db)
                    .setTitle(`Odadaki OyuncularÄ±n Listesi`)
                    .setDescription(`Haxball odasÄ±ndaki oyuncular aÅŸaÄŸÄ±da listelenmiÅŸtir.`)
                    .addFields(
                        { name: 'ğŸ”´ KÄ±rmÄ±zÄ± TakÄ±m', value: `\`\`\`\n${redList}\n\`\`\`` },
                        { name: 'ğŸ‘€ Ä°zleyiciler', value: `\`\`\`\n${spectatorList}\n\`\`\`` },
                        { name: 'ğŸ”µ Mavi TakÄ±m', value: `\`\`\`\n${blueList}\n\`\`\`` }
                    )
                    .setFooter({ text: ' Haxball OdalarÄ±' });
        
                await interaction.reply({ embeds: [embed] });
            } catch (error) {
                console.error('Hata oluÅŸtu:', error);
                await interaction.reply({
                    content: 'Oyuncu listesi alÄ±nÄ±rken bir hata oluÅŸtu.',
                    ephemeral: true,
                });
            }
            }
            
        } else if (commandName === 'oyuncuyuat') {
            if (!interaction.member.roles.cache.has(ADMIN_ROLE_ID)) {
                await interaction.reply({
                    content: 'Sadece adminler kullanabilir.',
                    ephemeral: true,
                });
                return false
            }
            const playerId = interaction.options.getInteger('id');
            const reason = interaction.options.getString('sebep'); // Sebep
            const banOption = interaction.options.getString('ban'); // Ban seÃ§eneÄŸi

                
            // Ban parametresinin geÃ§erli olup olmadÄ±ÄŸÄ±nÄ± kontrol et
            const ban = banOption.toLowerCase() === 'evet' ? true : banOption.toLowerCase() === 'hayÄ±r' ? false : null;
        
            if (ban === null) {
                await interaction.reply({
                    content: '`ban` parametresi sadece `evet` veya `hayÄ±r` olabilir.',
                    ephemeral: true,
                });
                return;
            }
        
            try {
                const room = client.room
        
                if (!room) {
                    await interaction.reply({
                        content: `Oda bulunamadÄ±.`,
                        ephemeral: true,
                    });
                    return;
                }
        
                // Oyuncunun atÄ±lmasÄ±
                const player = room.getPlayer(playerId);
                if (!player) {
                    await interaction.reply({
                        content: `ID'si ${playerId} olan oyuncu bulunamadÄ±.`,
                        ephemeral: true,
                    });
                    return;
                }
        
                // Oyuncuyu odadan atma iÅŸlemi
                room.kickPlayer(playerId, reason, ban);
        
                await interaction.reply({
                    content: `Oyuncu [${playerId}] ${player.name} ${ban ? 'banlandÄ±' : 'odadan atÄ±ldÄ±'}.\nSebep: ${reason}`,
                });
            } catch (error) {
                console.error('Hata oluÅŸtu:', error);
                await interaction.reply({
                    content: 'Oyuncuyu atarken bir hata oluÅŸtu.',
                    ephemeral: true,
                });
            }
        }

    } 
    
    

});


client.login(DÄ°SCORD_BOT_TOKEN);
